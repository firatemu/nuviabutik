{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Başlık ve Butonlar -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3>
                        <i class="fas fa-clipboard-list text-primary"></i>
                        Sipariş Detayı - {{ siparis.siparis_no }}
                    </h3>
                    <p class="text-muted mb-0">{{ siparis.olusturma_tarihi|date:"d.m.Y H:i" }}</p>
                </div>
                <div>
                    <a href="{% url 'satis:siparis_listesi' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-arrow-left"></i> Listeye Dön
                    </a>
                    {% if siparis.durum == 'hazir' %}
                    <button type="button" class="btn btn-success me-2" onclick="satisaDonustur()">
                        <i class="fas fa-cash-register"></i> Satışa Dönüştür
                    </button>
                    {% endif %}
                    {% if siparis.durum in 'taslak,hazir' %}
                    <button type="button" class="btn btn-info me-2" onclick="satisEkraninaYukle()">
                        <i class="fas fa-download"></i> Satış Ekranına Yükle
                    </button>
                    {% endif %}
                    {% if siparis.durum == 'taslak' %}
                    <button type="button" class="btn btn-danger" onclick="siparisSil()">
                        <i class="fas fa-trash"></i> Siparişi Sil
                    </button>
                    {% endif %}
                </div>
            </div>

            <div class="row">
                <!-- Sol Kolon - Sipariş Bilgileri -->
                <div class="col-md-8">
                    <!-- Genel Bilgiler -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle"></i> Genel Bilgiler
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <table class="table table-borderless table-sm">
                                        <tr>
                                            <td class="fw-bold">Sipariş No:</td>
                                            <td>{{ siparis.siparis_no }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Durum:</td>
                                            <td>
                                                {% if siparis.durum == 'taslak' %}
                                                <span class="badge bg-secondary">{{ siparis.get_durum_display }}</span>
                                                {% elif siparis.durum == 'hazir' %}
                                                <span class="badge bg-success">{{ siparis.get_durum_display }}</span>
                                                {% elif siparis.durum == 'satisa_donusturuldu' %}
                                                <span class="badge bg-primary">{{ siparis.get_durum_display }}</span>
                                                {% elif siparis.durum == 'iptal' %}
                                                <span class="badge bg-danger">{{ siparis.get_durum_display }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Satıcı:</td>
                                            <td>
                                                {% if siparis.satici %}
                                                {{ siparis.satici.first_name }} {{ siparis.satici.last_name }}
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless table-sm">
                                        <tr>
                                            <td class="fw-bold">Müşteri:</td>
                                            <td>
                                                {% if siparis.musteri %}
                                                {{ siparis.musteri.ad }} {{ siparis.musteri.soyad }}
                                                {% else %}
                                                <span class="text-muted">Perakende</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Oluşturma:</td>
                                            <td>{{ siparis.olusturma_tarihi|date:"d.m.Y H:i" }}</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Güncelleme:</td>
                                            <td>{{ siparis.guncelleme_tarihi|date:"d.m.Y H:i" }}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            {% if siparis.notlar %}
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <strong>Notlar:</strong><br>
                                        {{ siparis.notlar|linebreaks }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Ürün Listesi -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shopping-cart"></i> Sipariş Detayları
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Ürün</th>
                                            <th>Birim Fiyat</th>
                                            <th>Miktar</th>
                                            <th>İndirim</th>
                                            <th>Toplam</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for detay in siparis.detaylar.all %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if detay.urun.resim %}
                                                    <img src="{{ detay.urun.resim.url }}" alt="{{ detay.urun.ad }}"
                                                        class="product-thumb me-3">
                                                    {% else %}
                                                    <div class="product-thumb-placeholder me-3">
                                                        <i class="fas fa-image"></i>
                                                    </div>
                                                    {% endif %}
                                                    <div>
                                                        <strong>{{ detay.urun.ad }}</strong><br>
                                                        <small class="text-muted">Kod: {{ detay.urun.kod }}</small>
                                                        {% if detay.urun.barkod %}
                                                        <br><small class="text-muted">Barkod: {{ detay.urun.barkod
                                                            }}</small>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="text-end">₺{{ detay.birim_fiyat|floatformat:2 }}</td>
                                            <td class="text-center">
                                                <span class="badge bg-primary">{{ detay.miktar|floatformat:0 }}</span>
                                            </td>
                                            <td class="text-end">
                                                {% if detay.indirim_tutari > 0 %}
                                                <span class="text-danger">-₺{{ detay.indirim_tutari|floatformat:2
                                                    }}</span>
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end fw-bold text-success">
                                                ₺{{ detay.toplam_tutar|floatformat:2 }}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="fas fa-shopping-cart fa-2x mb-2"></i><br>
                                                Sipariş detayı bulunamadı.
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sağ Kolon - Ödeme ve Özet -->
                <div class="col-md-4">
                    <!-- Sipariş Özeti -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calculator"></i> Sipariş Özeti
                            </h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td>Ara Toplam:</td>
                                    <td class="text-end">₺{{ siparis.ara_toplam|floatformat:2 }}</td>
                                </tr>
                                <tr>
                                    <td>İndirim:</td>
                                    <td class="text-end text-danger">
                                        {% if siparis.indirim_tutari > 0 %}
                                        -₺{{ siparis.indirim_tutari|floatformat:2 }}
                                        {% else %}
                                        ₺0.00
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>KDV:</td>
                                    <td class="text-end">₺{{ siparis.kdv_tutari|floatformat:2 }}</td>
                                </tr>
                                <tr class="border-top">
                                    <td class="fw-bold">Genel Toplam:</td>
                                    <td class="text-end fw-bold text-success h5">
                                        ₺{{ siparis.genel_toplam|floatformat:2 }}
                                    </td>
                                </tr>
                            </table>

                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-box"></i>
                                    {{ siparis.urun_sayisi }} ürün
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Ödeme Bilgileri -->
                    {% if siparis.odeme_yontemi %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-credit-card"></i> Ödeme Bilgileri
                            </h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="fw-bold">Ödeme Yöntemi:</td>
                                    <td>
                                        {% if siparis.odeme_yontemi == 'nakit' %}
                                        <i class="fas fa-money-bill-wave text-success"></i> Nakit
                                        {% elif siparis.odeme_yontemi == 'kredi_karti' %}
                                        <i class="fas fa-credit-card text-primary"></i> Kredi Kartı
                                        {% elif siparis.odeme_yontemi == 'banka_havalesi' %}
                                        <i class="fas fa-university text-info"></i> Banka Havalesi
                                        {% elif siparis.odeme_yontemi == 'cek' %}
                                        <i class="fas fa-file-invoice text-warning"></i> Çek
                                        {% elif siparis.odeme_yontemi == 'senet' %}
                                        <i class="fas fa-scroll text-secondary"></i> Senet
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if siparis.odeme_yontemi == 'kredi_karti' and siparis.banka %}
                                <tr>
                                    <td class="fw-bold">Banka:</td>
                                    <td>{{ siparis.banka }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>
                    {% endif %}

                    <!-- İşlem Geçmişi -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history"></i> İşlem Geçmişi
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="timeline">
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-primary"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Sipariş Oluşturuldu</h6>
                                        <small class="text-muted">{{ siparis.olusturma_tarihi|date:"d.m.Y H:i"
                                            }}</small>
                                    </div>
                                </div>

                                {% if siparis.durum == 'hazir' %}
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-success"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Satışa Hazır</h6>
                                        <small class="text-muted">{{ siparis.guncelleme_tarihi|date:"d.m.Y H:i"
                                            }}</small>
                                    </div>
                                </div>
                                {% endif %}

                                {% if siparis.durum == 'satisa_donusturuldu' %}
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-info"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Satışa Dönüştürüldü</h6>
                                        <small class="text-muted">{{ siparis.guncelleme_tarihi|date:"d.m.Y H:i"
                                            }}</small>
                                    </div>
                                </div>
                                {% endif %}

                                {% if siparis.durum == 'iptal' %}
                                <div class="timeline-item">
                                    <div class="timeline-marker bg-danger"></div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">İptal Edildi</h6>
                                        <small class="text-muted">{{ siparis.guncelleme_tarihi|date:"d.m.Y H:i"
                                            }}</small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .product-thumb {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .product-thumb-placeholder {
        width: 50px;
        height: 50px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
    }

    .timeline {
        position: relative;
        padding: 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }

    .timeline-item {
        position: relative;
        padding-left: 40px;
        padding-bottom: 20px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-marker {
        position: absolute;
        left: 8px;
        top: 0;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #e9ecef;
    }

    .timeline-content h6 {
        margin: 0;
        font-size: 0.875rem;
    }

    .card-header h5 {
        font-size: 1rem;
    }

    .table-borderless td {
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function satisaDonustur() {
        if (confirm('Bu siparişi satışa dönüştürmek istediğinizden emin misiniz?')) {
            $.ajax({
                url: '{% url "satis:siparis_satisa_donustur" siparis.id %}',
                method: 'POST',
                success: function (response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        showAlert('danger', response.message);
                    }
                },
                error: function () {
                    showAlert('danger', 'İşlem sırasında hata oluştu');
                }
            });
        }
    }

    function satisEkraninaYukle() {
        if (confirm('Bu siparişteki ürünleri satış ekranına yüklemek istediğinizden emin misiniz?')) {
            const url = `/satis/?siparis_id={{ siparis.id }}`;
            window.open(url, '_blank');
        }
    }

    function siparisSil() {
        if (confirm('Bu taslak siparişi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) {
            $.ajax({
                url: `/satis/siparis/{{ siparis.id }}/sil/`,
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {
                    if (response.success) {
                        showAlert('success', response.message);
                        setTimeout(() => {
                            window.location.href = '{% url "satis:siparis_listesi" %}';
                        }, 1500);
                    } else {
                        showAlert('danger', response.message);
                    }
                },
                error: function () {
                    showAlert('danger', 'Sipariş silinirken hata oluştu');
                }
            });
        }
    }

    function showAlert(type, message, duration = 4000) {
        const alertId = 'alert-' + Date.now();
        const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;

        $('body').append(alertHtml);

        setTimeout(() => {
            $(`#${alertId}`).alert('close');
        }, duration);
    }
</script>
{% endblock %}