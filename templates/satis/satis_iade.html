{% extends 'base.html' %}
{% load humanize %}

{% block title %}SatÄ±ÅŸ Ä°ade{% endblock %}

{% block extra_css %}
<style>
    .iade-card {
        max-width: 600px;
        margin: 0 auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .warning-box {
        background: linear-gradient(135deg, #fff3cd, #ffeaa7);
        border-left: 4px solid #856404;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .satis-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .amount-highlight {
        font-size: 1.5rem;
        font-weight: bold;
        color: #dc3545;
    }
    
    .urun-satiri {
        transition: background-color 0.2s ease;
    }
    
    .urun-satiri:hover {
        background-color: #f8f9fa;
    }
    
    .iade-miktar {
        max-width: 80px;
        text-align: center;
    }
    
    .iade-tutar {
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .form-check-input:checked {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .table-responsive {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #iade-ozeti {
        border-left: 4px solid #0dcaf0;
        background: linear-gradient(135deg, #e7f7ff, #cce7ff);
    }
    
    /* Custom alert styling to replace Bootstrap alert */
    .custom-alert {
        position: relative;
        padding: 1rem 1rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.375rem;
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }
    
    .custom-alert-heading {
        color: inherit;
        margin-bottom: 0.5rem;
        font-weight: 500;
        line-height: 1.2;
    }
    
    .btn-group .btn {
        border-radius: 0;
    }
    
    .btn-group .btn:first-child {
        border-top-left-radius: 0.375rem;
        border-bottom-left-radius: 0.375rem;
    }
    
    .btn-group .btn:last-child {
        border-top-right-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card iade-card">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-undo me-2"></i>
                        SatÄ±ÅŸ Ä°ade Ä°ÅŸlemi
                    </h4>
                </div>
                <div class="card-body">
                    <!-- UyarÄ± Kutusu -->
                    <div class="warning-box">
                        <h5 class="text-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Dikkat!
                        </h5>
                        <p class="mb-2">
                            Bu satÄ±ÅŸ iade edildiÄŸinde, iade tutarÄ± kadar <strong>hediye Ã§eki</strong> otomatik olarak oluÅŸturulacaktÄ±r.
                        </p>
                        <ul class="mb-0">
                            <li>Hediye Ã§eki 1 yÄ±l geÃ§erli olacaktÄ±r</li>
                            <li>Sadece maÄŸazamÄ±zda kullanÄ±labilir</li>
                            <li>Tek seferlik kullanÄ±labilir</li>
                            <li>Para Ã¼stÃ¼ verilmez</li>
                        </ul>
                    </div>

                    <!-- SatÄ±ÅŸ Bilgileri -->
                    <div class="satis-info">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-receipt me-2"></i>
                            Ä°ade Edilecek SatÄ±ÅŸ Bilgileri
                        </h5>
                        
                        <div class="row">
                            <div class="col-sm-6 mb-2">
                                <strong>SatÄ±ÅŸ No:</strong> {{ satis.satis_no|default:satis.siparis_no }}
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>SatÄ±ÅŸ Tarihi:</strong> {{ satis.siparis_tarihi|date:"d.m.Y H:i" }}
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>MÃ¼ÅŸteri:</strong>
                                {% if satis.musteri %}
                                    {{ satis.musteri.ad }} {{ satis.musteri.soyad }}
                                {% else %}
                                    <span class="text-muted">Bireysel SatÄ±ÅŸ</span>
                                {% endif %}
                            </div>
                            <div class="col-sm-6 mb-2">
                                <strong>SatÄ±cÄ±:</strong> {{ satis.satici.first_name|default:satis.satici.username }}
                            </div>
                            <div class="col-12 mb-2">
                                <strong>Toplam SatÄ±ÅŸ TutarÄ±:</strong>
                                <span class="text-success">{{ satis.toplam_tutar|floatformat:2 }} â‚º</span>
                            </div>
                            <div class="col-12">
                                <strong>Ä°ade TutarÄ±:</strong>
                                <span class="amount-highlight" id="toplam-iade-tutari">0,00 â‚º</span>
                            </div>
                        </div>
                    </div>

                    <!-- Ä°ade Edilecek ÃœrÃ¼nler -->
                    <div class="mb-4">
                        <h5 class="text-warning mb-3">
                            <i class="fas fa-shopping-cart me-2"></i>
                            Ä°ade Edilecek ÃœrÃ¼nleri SeÃ§in
                        </h5>
                        <p class="text-muted small mb-3">
                            <i class="fas fa-info-circle me-1"></i>
                            Ä°ade etmek istediÄŸiniz Ã¼rÃ¼nleri ve miktarlarÄ±nÄ± seÃ§in. Ä°ade edilecek Ã¼rÃ¼nler otomatik olarak stoka geri eklenecektir.
                        </p>
                        
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40%;">ÃœrÃ¼n</th>
                                        <th class="text-center" style="width: 15%;">SatÄ±lan</th>
                                        <th class="text-center" style="width: 15%;">Ä°ade Miktar</th>
                                        <th class="text-end" style="width: 15%;">Birim Fiyat</th>
                                        <th class="text-end" style="width: 15%;">Ä°ade TutarÄ±</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for kalem in kalemler %}
                                    <tr class="urun-satiri" data-urun-id="{{ kalem.id }}" data-birim-fiyat="{{ kalem.birim_fiyat }}" data-max-miktar="{{ kalem.miktar }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="form-check me-2">
                                                    <input class="form-check-input urun-secim" 
                                                           type="checkbox" 
                                                           id="urun_{{ kalem.id }}" 
                                                           name="urun_secili_{{ kalem.id }}"
                                                           onchange="urunSecimDegisti({{ kalem.id }})">
                                                </div>
                                                <div>
                                                    <strong>{{ kalem.urun.ad }}</strong>
                                                    {% if kalem.urun.barkod %}
                                                        <br><small class="text-muted">{{ kalem.urun.barkod }}</small>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary">{{ kalem.miktar }} adet</span>
                                        </td>
                                        <td class="text-center">
                                            <input type="number" 
                                                   class="form-control form-control-sm iade-miktar" 
                                                   id="iade_miktar_{{ kalem.id }}"
                                                   name="iade_miktar_{{ kalem.id }}"
                                                   min="0" 
                                                   max="{{ kalem.miktar }}" 
                                                   value="0"
                                                   disabled
                                                   onchange="hesaplaIadeTutari({{ kalem.id }})"
                                                   style="width: 80px;">
                                        </td>
                                        <td class="text-end">
                                            {{ kalem.birim_fiyat|floatformat:2 }} â‚º
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-warning text-dark iade-tutar" id="iade_tutar_{{ kalem.id }}">0,00 â‚º</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-warning">
                                        <td colspan="4" class="text-end"><strong>Toplam Ä°ade TutarÄ±:</strong></td>
                                        <td class="text-end">
                                            <strong class="fs-5 text-danger" id="footer-toplam-iade">0,00 â‚º</strong>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        
                        <!-- HÄ±zlÄ± SeÃ§im ButonlarÄ± -->
                        <div class="mb-3">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="tumunuSec()">
                                    <i class="fas fa-check-square me-1"></i>TÃ¼mÃ¼nÃ¼ SeÃ§
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="hepsiniTemizle()">
                                    <i class="fas fa-square me-1"></i>Temizle
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="tamIadeYap()">
                                    <i class="fas fa-undo me-1"></i>Tam Ä°ade
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Ä°ade Formu -->
                    <form method="post" id="iade-formu">
                        {% csrf_token %}
                        
                        <div class="custom-alert" id="iade-ozeti" style="display: none;">
                            <h6 class="custom-alert-heading">
                                <i class="fas fa-clipboard-list me-2"></i>
                                Ä°ade Ã–zeti
                            </h6>
                            <div id="iade-ozeti-icerik"></div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'satis:liste' %}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-arrow-left me-2"></i>
                                Geri DÃ¶n
                            </a>
                            <button type="submit" class="btn btn-danger" id="iade-btn" disabled>
                                <i class="fas fa-undo me-2"></i>
                                Ä°ade Et ve Hediye Ã‡eki OluÅŸtur
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let toplamIadeTutari = 0;

// ÃœrÃ¼n seÃ§imi deÄŸiÅŸtiÄŸinde
function urunSecimDegisti(kalemId) {
    // DOM hazÄ±r mÄ± kontrol et
    if (document.readyState !== 'complete') {
        console.log('DOM henÃ¼z hazÄ±r deÄŸil, 100ms beklenecek...');
        setTimeout(function() { urunSecimDegisti(kalemId); }, 100);
        return;
    }
    
    const checkbox = document.getElementById(`urun_${kalemId}`);
    const miktarInput = document.getElementById(`iade_miktar_${kalemId}`);
    const urunSatir = document.querySelector(`[data-urun-id="${kalemId}"]`);
    
    // Elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et
    if (!checkbox || !miktarInput || !urunSatir) {
        console.error(`ÃœrÃ¼n seÃ§im deÄŸiÅŸikliÄŸi iÃ§in gerekli elementler bulunamadÄ±: kalemId=${kalemId}`);
        return;
    }
    
    const maxMiktar = parseInt(urunSatir.dataset.maxMiktar) || 0;
    
    if (checkbox.checked) {
        miktarInput.disabled = false;
        miktarInput.value = maxMiktar; // VarsayÄ±lan olarak tam miktar
        hesaplaIadeTutari(kalemId);
    } else {
        miktarInput.disabled = true;
        miktarInput.value = 0;
        hesaplaIadeTutari(kalemId);
    }
}

// Ä°ade tutarÄ±nÄ± hesapla
function hesaplaIadeTutari(kalemId) {
    const miktarInput = document.getElementById(`iade_miktar_${kalemId}`);
    const iadeTutarSpan = document.getElementById(`iade_tutar_${kalemId}`);
    const urunSatir = document.querySelector(`[data-urun-id="${kalemId}"]`);
    
    // Elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et
    if (!miktarInput || !iadeTutarSpan || !urunSatir) {
        console.error(`Ä°ade hesaplama iÃ§in gerekli elementler bulunamadÄ±: kalemId=${kalemId}`);
        return;
    }
    
    const birimFiyat = parseFloat(urunSatir.dataset.birimFiyat) || 0;
    const miktar = parseInt(miktarInput.value) || 0;
    const tutarHesaplanan = miktar * birimFiyat;
    
    iadeTutarSpan.textContent = formatTurkishCurrency(tutarHesaplanan);
    
    // Toplam iade tutarÄ±nÄ± gÃ¼ncelle
    toplamIadeHesapla();
}

// Toplam iade tutarÄ±nÄ± hesapla
function toplamIadeHesapla() {
    console.log('toplamIadeHesapla Ã§aÄŸrÄ±ldÄ±');
    toplamIadeTutari = 0;
    const iadeTutarSpanlar = document.querySelectorAll('.iade-tutar');
    
    iadeTutarSpanlar.forEach(span => {
        const tutar = parseFloat(span.textContent.replace(' â‚º', '').replace(',', '.')) || 0;
        toplamIadeTutari += tutar;
    });
    
    // Toplam tutarlarÄ± gÃ¼ncelle - elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et
    const toplamIadeElement = document.getElementById('toplam-iade-tutari');
    const footerToplamElement = document.getElementById('footer-toplam-iade');
    
    if (toplamIadeElement) {
        toplamIadeElement.textContent = formatTurkishCurrency(toplamIadeTutari);
    }
    if (footerToplamElement) {
        footerToplamElement.textContent = formatTurkishCurrency(toplamIadeTutari);
    }
    
    // Ä°ade butonunu aktif/pasif yap
    const iadeBtn = document.getElementById('iade-btn');
    if (iadeBtn) {
        if (toplamIadeTutari > 0) {
            console.log('Toplam tutar > 0, iade butonu aktif ediliyor ve Ã¶zet gÃ¶steriliyor');
            iadeBtn.disabled = false;
            
            // Ã–zet gÃ¶stermeden Ã¶nce element durumunu kontrol et
            console.log('Ã–zet gÃ¶stermeden Ã–NCE element kontrolÃ¼:');
            const preCheck_icerik = document.getElementById('iade-ozeti-icerik');
            const preCheck_div = document.getElementById('iade-ozeti');
            console.log('- iade-ozeti-icerik:', !!preCheck_icerik);
            console.log('- iade-ozeti:', !!preCheck_div);
            
            // Sadece tutar sÄ±fÄ±rdan bÃ¼yÃ¼kse Ã¶zet gÃ¶ster
            iadeOzetiGoster();
        } else {
            console.log('Toplam tutar = 0, iade butonu pasif ediliyor ve Ã¶zet gizleniyor');
            iadeBtn.disabled = true;
            iadeOzetiGizle();
        }
    } else {
        console.warn('Ä°ade butonu bulunamadÄ±');
    }
}

// Para formatÄ±
function formatTurkishCurrency(amount) {
    return new Intl.NumberFormat('tr-TR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount) + ' â‚º';
}

// TÃ¼mÃ¼nÃ¼ seÃ§
function tumunuSec() {
    const checkboxes = document.querySelectorAll('.urun-secim');
    checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
            checkbox.checked = true;
            const kalemId = checkbox.id.replace('urun_', '');
            urunSecimDegisti(kalemId);
        }
    });
}

// Hepsini temizle
function hepsiniTemizle() {
    const checkboxes = document.querySelectorAll('.urun-secim');
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            checkbox.checked = false;
            const kalemId = checkbox.id.replace('urun_', '');
            urunSecimDegisti(kalemId);
        }
    });
}

// Tam iade yap (tÃ¼m Ã¼rÃ¼nlerin tam miktarÄ±nÄ± seÃ§)
function tamIadeYap() {
    tumunuSec();
}

// Ä°ade Ã¶zeti gÃ¶ster
function iadeOzetiGoster() {
    const secilenUrunler = [];
    const checkboxes = document.querySelectorAll('.urun-secim:checked');
    
    console.log('iadeOzetiGoster Ã§aÄŸrÄ±ldÄ±, seÃ§ili Ã¼rÃ¼n sayÄ±sÄ±:', checkboxes.length);
    
    // EÄŸer hiÃ§ seÃ§ili Ã¼rÃ¼n yoksa Ã¶zeti gÃ¶stermeye gerek yok
    if (checkboxes.length === 0) {
        console.log('HiÃ§ seÃ§ili Ã¼rÃ¼n yok, Ã¶zet gizleniyor');
        iadeOzetiGizle();
        return;
    }
    
    checkboxes.forEach(checkbox => {
        const kalemId = checkbox.id.replace('urun_', '');
        const satir = document.querySelector(`[data-urun-id="${kalemId}"]`);
        if (!satir) {
            console.warn(`SatÄ±r bulunamadÄ±: kalemId=${kalemId}`);
            return; // SatÄ±r bulunamazsa geÃ§
        }
        
        const urunAdiElement = satir.querySelector('strong');
        const miktarElement = document.getElementById(`iade_miktar_${kalemId}`);
        const tutarElement = document.getElementById(`iade_tutar_${kalemId}`);
        
        if (!urunAdiElement || !miktarElement || !tutarElement) {
            console.warn(`Alt elementler bulunamadÄ±: kalemId=${kalemId}`, {
                urunAdi: !!urunAdiElement,
                miktar: !!miktarElement,
                tutar: !!tutarElement
            });
            return; // Elementler bulunamazsa geÃ§
        }
        
        const urunAdi = urunAdiElement.textContent;
        const miktar = miktarElement.value;
        const tutar = tutarElement.textContent;
        
        secilenUrunler.push(`â€¢ ${urunAdi}: ${miktar} adet - ${tutar}`);
    });
    
    // Element var mÄ± kontrol et - multiple methods with cache clearing
    let ozeti_icerik = document.getElementById('iade-ozeti-icerik');
    let ozeti_div = document.getElementById('iade-ozeti');
    
    // DOM Cache clearing trick
    if (!ozeti_icerik || !ozeti_div) {
        console.log('getElementById baÅŸarÄ±sÄ±z, cache temizlenerek tekrar denenecek...');
        // Force DOM reparse by accessing document.documentElement
        document.documentElement.offsetHeight; // Force reflow
        
        ozeti_icerik = document.getElementById('iade-ozeti-icerik');
        ozeti_div = document.getElementById('iade-ozeti');
    }
    
    // EÄŸer getElementById ile bulunamadÄ±ysa querySelector dene
    if (!ozeti_icerik) {
        ozeti_icerik = document.querySelector('#iade-ozeti-icerik');
        console.log('getElementById baÅŸarÄ±sÄ±z, querySelector ile bulundu:', !!ozeti_icerik);
    }
    if (!ozeti_div) {
        ozeti_div = document.querySelector('#iade-ozeti');
        console.log('getElementById baÅŸarÄ±sÄ±z, querySelector ile bulundu:', !!ozeti_div);
    }
    
    // Form iÃ§inde direkt arama
    if (!ozeti_icerik || !ozeti_div) {
        const form = document.getElementById('iade-formu');
        if (form) {
            if (!ozeti_div) {
                ozeti_div = form.querySelector('#iade-ozeti');
                console.log('Form iÃ§inde Ã¶zet div bulundu:', !!ozeti_div);
            }
            if (!ozeti_icerik) {
                ozeti_icerik = form.querySelector('#iade-ozeti-icerik');
                console.log('Form iÃ§inde Ã¶zet iÃ§erik bulundu:', !!ozeti_icerik);
            }
        }
    }
    
    // Hala bulunamadÄ±ysa tÃ¼m elementleri listele
    if (!ozeti_icerik || !ozeti_div) {
        console.log('Elementler hala bulunamadÄ±, DOM inceleniyor...');
        const allDivs = document.querySelectorAll('div[id*="iade"]');
        console.log('iade iÃ§eren tÃ¼m div\'ler:', Array.from(allDivs).map(d => `${d.tagName}#${d.id}`));
        
        const form = document.getElementById('iade-formu');
        if (form) {
            console.log('Form iÃ§indeki tÃ¼m elementler:');
            const formElements = form.querySelectorAll('*[id]');
            Array.from(formElements).forEach(el => {
                console.log(`- ${el.tagName}#${el.id}`);
            });
        }
    }
    
    console.log('Ã–zet elementleri kontrolÃ¼:', {
        ozeti_icerik: !!ozeti_icerik,
        ozeti_div: !!ozeti_div,
        secilenUrunSayisi: secilenUrunler.length
    });
    
    if (!ozeti_icerik || !ozeti_div) {
        console.warn('Ä°ade Ã¶zeti elementleri henÃ¼z yÃ¼klenemedi, fonksiyon Ã§Ä±kÄ±lÄ±yor');
        
        // Son Ã§are: Elementleri yeniden oluÅŸturmaya Ã§alÄ±ÅŸ (SADECE gerÃ§ekten yoksa)
        console.log('Elementleri yeniden oluÅŸturmaya Ã§alÄ±ÅŸÄ±lÄ±yor...');
        const form = document.getElementById('iade-formu');
        if (form) {
            // Ã–nce gerÃ§ekten Ã¶zet div'i yoksa kontrol et
            const existingOzeti = form.querySelector('#iade-ozeti');
            if (!existingOzeti) {
                console.log('Ã–zet div\'i gerÃ§ekten yok, yeniden oluÅŸturuluyor...');
                
                // Ã–zet div'ini yeniden oluÅŸtur
                const newOzetiDiv = document.createElement('div');
                newOzetiDiv.id = 'iade-ozeti';
                newOzetiDiv.className = 'custom-alert';
                newOzetiDiv.style.display = 'none';
                newOzetiDiv.setAttribute('data-protected', 'true');
                newOzetiDiv.innerHTML = `
                    <h6 class="custom-alert-heading">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Ä°ade Ã–zeti
                    </h6>
                    <div id="iade-ozeti-icerik"></div>
                `;
                
                // Form'un baÅŸÄ±na ekle
                const firstChild = form.firstElementChild;
                if (firstChild && firstChild.tagName === 'INPUT' && firstChild.name === 'csrfmiddlewaretoken') {
                    form.insertBefore(newOzetiDiv, firstChild.nextElementSibling);
                } else {
                    form.insertBefore(newOzetiDiv, firstChild);
                }
                
                console.log('Ã–zet div\'i yeniden oluÅŸturuldu');
                
                // Tekrar dene
                setTimeout(function() {
                    iadeOzetiGoster();
                }, 100);
                return;
            } else {
                console.log('Ã–zet div\'i zaten var ama getElementById ile bulunamÄ±yor, caching sorunu olabilir');
                // Cache problemi olabilir, 50ms sonra tekrar dene
                setTimeout(function() {
                    iadeOzetiGoster();
                }, 50);
                return;
            }
        }
        
        // Element bulunamadÄ±ÄŸÄ±nda da Ã¶zeti gizlemeye Ã§alÄ±ÅŸ
        const alternatif_div = document.querySelector('#iade-ozeti');
        if (alternatif_div) {
            alternatif_div.style.display = 'none';
        }
        return;
    }
    
    if (secilenUrunler.length > 0) {
        console.log('Ã–zet gÃ¶steriliyor, toplam tutar:', toplamIadeTutari);
        
        // Ã–zet iÃ§eriÄŸini gÃ¼ncelle
        ozeti_icerik.innerHTML = 
            `<p class="mb-1"><strong>Ä°ade edilecek Ã¼rÃ¼nler:</strong></p>
             ${secilenUrunler.join('<br>')}
             <hr class="my-2">
             <p class="mb-0"><strong>Toplam: ${formatTurkishCurrency(toplamIadeTutari)}</strong></p>`;
        
        // Element hala DOM'da mÄ± kontrol et
        if (ozeti_div.parentNode) {
            ozeti_div.style.display = 'block';
            console.log('Ã–zet baÅŸarÄ±yla gÃ¶sterildi');
            
            // Element korunmasÄ± iÃ§in attribut ekle
            ozeti_div.setAttribute('data-protected', 'true');
            ozeti_icerik.setAttribute('data-protected', 'true');
        } else {
            console.warn('Ã–zet div\'i DOM\'dan kaldÄ±rÄ±lmÄ±ÅŸ, tekrar oluÅŸturuluyor...');
            // Element DOM'dan kaldÄ±rÄ±lmÄ±ÅŸsa tekrar oluÅŸtur
            const form = document.getElementById('iade-formu');
            if (form) {
                const recreatedDiv = document.createElement('div');
                recreatedDiv.id = 'iade-ozeti';
                recreatedDiv.className = 'custom-alert';
                recreatedDiv.setAttribute('data-protected', 'true');
                recreatedDiv.innerHTML = `
                    <h6 class="custom-alert-heading">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Ä°ade Ã–zeti
                    </h6>
                    <div id="iade-ozeti-icerik" data-protected="true">
                        <p class="mb-1"><strong>Ä°ade edilecek Ã¼rÃ¼nler:</strong></p>
                        ${secilenUrunler.join('<br>')}
                        <hr class="my-2">
                        <p class="mb-0"><strong>Toplam: ${formatTurkishCurrency(toplamIadeTutari)}</strong></p>
                    </div>
                `;
                recreatedDiv.style.display = 'block';
                
                const firstChild = form.firstElementChild;
                if (firstChild && firstChild.tagName === 'INPUT' && firstChild.name === 'csrfmiddlewaretoken') {
                    form.insertBefore(recreatedDiv, firstChild.nextElementSibling);
                } else {
                    form.insertBefore(recreatedDiv, firstChild);
                }
                console.log('Ã–zet div\'i yeniden oluÅŸturuldu ve gÃ¶sterildi');
            }
        }
    } else {
        console.log('SeÃ§ili Ã¼rÃ¼n yok, Ã¶zet gizleniyor');
        if (ozeti_div && ozeti_div.parentNode) {
            ozeti_div.style.display = 'none';
        }
    }
}

// Ä°ade Ã¶zeti gizle
function iadeOzetiGizle() {
    console.log('iadeOzetiGizle Ã§aÄŸrÄ±ldÄ±');
    const ozeti_div = document.getElementById('iade-ozeti');
    if (ozeti_div) {
        ozeti_div.style.display = 'none';
        console.log('Ä°ade Ã¶zeti gizlendi');
    } else {
        console.warn('Ä°ade Ã¶zeti div bulunamadÄ±, gizlenemedi');
    }
}

// Form gÃ¶nderilmeden Ã¶nce onay
document.getElementById('iade-formu').addEventListener('submit', function(e) {
    console.log('ðŸ” JS DEBUG: Form submit event tetiklendi');
    
    const secilenCheckboxlar = document.querySelectorAll('.urun-secim:checked');
    const secilenUrunSayisi = secilenCheckboxlar.length;
    console.log(`ðŸ” JS DEBUG: SeÃ§ilen checkbox sayÄ±sÄ±: ${secilenUrunSayisi}`);
    console.log('ðŸ” JS DEBUG: SeÃ§ilen checkboxlar:', Array.from(secilenCheckboxlar).map(cb => cb.id));
    console.log(`ðŸ” JS DEBUG: Toplam iade tutarÄ±: ${toplamIadeTutari}`);
    
    if (secilenUrunSayisi === 0) {
        console.log('ðŸ” JS DEBUG: HiÃ§ Ã¼rÃ¼n seÃ§ilmemiÅŸ, form gÃ¶nderimini engelliyor');
        e.preventDefault();
        alert('Ä°ade iÃ§in en az bir Ã¼rÃ¼n seÃ§melisiniz!');
        return;
    }
    
    console.log('ðŸ” JS DEBUG: KullanÄ±cÄ±dan onay isteniyor...');
    const confirmed = confirm(
        `${secilenUrunSayisi} Ã¼rÃ¼n iÃ§in iade iÅŸlemi yapÄ±lacak.\n` +
        `Toplam iade tutarÄ±: ${formatTurkishCurrency(toplamIadeTutari)}\n\n` +
        `â€¢ SeÃ§ilen Ã¼rÃ¼nler stoka geri eklenecek\n` +
        `â€¢ ${formatTurkishCurrency(toplamIadeTutari)} tutarÄ±nda hediye Ã§eki oluÅŸturulacak\n` +
        `â€¢ Bu iÅŸlem geri alÄ±namaz\n\n` +
        `Ä°ade iÅŸlemini onaylÄ±yor musunuz?`
    );
    
    if (!confirmed) {
        console.log('ðŸ” JS DEBUG: KullanÄ±cÄ± onaylamadÄ±, form gÃ¶nderimini engelliyor');
        e.preventDefault();
    } else {
        console.log('ðŸ” JS DEBUG: KullanÄ±cÄ± onayladÄ±, form gÃ¶nderiliyor...');
        // Form verilerini logla
        const formData = new FormData(document.getElementById('iade-formu'));
        console.log('ðŸ” JS DEBUG: Form verileri:');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
    }
});

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', function() {
    console.log('Ä°ade sayfasÄ± DOM yÃ¼klendi');
    
    // Elementlerin varlÄ±ÄŸÄ±nÄ± kontrol et
    setTimeout(function() {
        const form = document.getElementById('iade-formu');
        const ozeti_icerik = document.getElementById('iade-ozeti-icerik');
        const ozeti_div = document.getElementById('iade-ozeti');
        const iadeBtn = document.getElementById('iade-btn');
        
        console.log('Element kontrolleri:');
        console.log('- iade-formu:', form ? 'Bulundu' : 'BulunamadÄ±');
        console.log('- iade-ozeti-icerik:', ozeti_icerik ? 'Bulundu' : 'BulunamadÄ±');
        console.log('- iade-ozeti:', ozeti_div ? 'Bulundu' : 'BulunamadÄ±');
        console.log('- iade-btn:', iadeBtn ? 'Bulundu' : 'BulunamadÄ±');
        
        // EÄŸer temel elementler yoksa, sayfa henÃ¼z tam yÃ¼klenmemiÅŸ demektir
        if (!form || !ozeti_icerik || !ozeti_div || !iadeBtn) {
            console.warn('Temel elementler henÃ¼z yÃ¼klenmedi, tekrar deneniyor...');
            setTimeout(arguments.callee, 200); // 200ms sonra tekrar dene
            return;
        }
        
        console.log('TÃ¼m elementler hazÄ±r, iade sayfasÄ± kullanÄ±ma hazÄ±r');
        
        // Custom alert kullandÄ±ÄŸÄ±mÄ±z iÃ§in Bootstrap Alert ile ilgili iÅŸlem yapmaya gerek yok
        console.log('Custom alert sistemi aktif, Bootstrap mÃ¼dahalesi yok');
        
        // Manuel element test
        console.log('Manuel element testleri:');
        const testElements = {
            'iade-ozeti': document.getElementById('iade-ozeti'),
            'iade-ozeti-icerik': document.getElementById('iade-ozeti-icerik'),
            'iade-btn': document.getElementById('iade-btn'),
            'iade-formu': document.getElementById('iade-formu')
        };
        
        Object.keys(testElements).forEach(key => {
            const element = testElements[key];
            console.log(`- ${key}:`, element ? 'Bulundu' : 'BulunamadÄ±');
            if (element) {
                console.log(`  - visible:`, element.offsetParent !== null);
                console.log(`  - display:`, getComputedStyle(element).display);
            }
        });
        
        // Test iÃ§in Ã¶zet gÃ¶sterme fonksiyonu ekle
        window.testOzetiGoster = function() {
            console.log('TEST: Ã–zet gÃ¶steriliyor...');
            const ozeti_div = document.getElementById('iade-ozeti');
            const ozeti_icerik = document.getElementById('iade-ozeti-icerik');
            
            if (ozeti_div && ozeti_icerik) {
                ozeti_icerik.innerHTML = '<p>TEST: Bu bir test mesajÄ±dÄ±r</p>';
                ozeti_div.style.display = 'block';
                console.log('TEST: Ã–zet baÅŸarÄ±yla gÃ¶sterildi');
            } else {
                console.error('TEST: Ã–zet elementleri bulunamadÄ±');
            }
        };
        
        console.log('Test fonksiyonu hazÄ±r. Console\'da testOzetiGoster() Ã§aÄŸÄ±rabilirsiniz.');
        
        // DOM deÄŸiÅŸikliklerini izle ve korumalÄ± elementleri koru
        const targetNode = document.getElementById('iade-formu');
        if (targetNode) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        console.log('DOM CHANGE: Form iÃ§inde element deÄŸiÅŸikliÄŸi:', mutation);
                        
                        // KaldÄ±rÄ±lan elementleri kontrol et
                        if (mutation.removedNodes.length > 0) {
                            Array.from(mutation.removedNodes).forEach(node => {
                                if (node.nodeType === 1 && node.id) {
                                    console.log('REMOVED NODE:', node.id);
                                    
                                    // EÄŸer korumalÄ± bir element kaldÄ±rÄ±lmÄ±ÅŸsa geri ekle
                                    if (node.getAttribute && node.getAttribute('data-protected') === 'true') {
                                        console.warn('KorumalÄ± element kaldÄ±rÄ±ldÄ±, geri ekleniyor:', node.id);
                                        
                                        setTimeout(function() {
                                            if (!document.getElementById(node.id)) {
                                                const form = document.getElementById('iade-formu');
                                                if (form) {
                                                    const firstChild = form.firstElementChild;
                                                    if (firstChild && firstChild.tagName === 'INPUT' && firstChild.name === 'csrfmiddlewaretoken') {
                                                        form.insertBefore(node, firstChild.nextElementSibling);
                                                    } else {
                                                        form.insertBefore(node, firstChild);
                                                    }
                                                    console.log('KorumalÄ± element baÅŸarÄ±yla geri eklendi:', node.id);
                                                }
                                            }
                                        }, 10);
                                    }
                                }
                            });
                        }
                        
                        // Eklenen elementleri logla
                        if (mutation.addedNodes.length > 0) {
                            Array.from(mutation.addedNodes).forEach(node => {
                                if (node.nodeType === 1 && node.id) {
                                    console.log('ADDED NODE:', node.id);
                                }
                            });
                        }
                    }
                });
            });
            
            observer.observe(targetNode, {
                childList: true,
                subtree: true
            });
            
            console.log('DOM Mutation Observer aktif - korumalÄ± elementler izleniyor');
        }
        
        // Ä°lk yÃ¼klemede hesaplama yapmaya gerek yok, Ã¼rÃ¼n seÃ§imi yapÄ±ldÄ±ÄŸÄ±nda zaten hesaplanacak
        // toplamIadeHesapla();
    }, 100); // 100ms bekle
});
</script>
{% endblock %}
