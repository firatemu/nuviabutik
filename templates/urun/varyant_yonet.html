{% extends "base.html" %}
{% load static %}
{% load currency_filters %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Sayfa Başlığı -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h3 mb-0 text-primary">
                        <i class="fas fa-boxes me-2"></i>{{ title }}
                    </h2>
                    <p class="text-muted mb-0">Temel Ürün: {{ urun.ad }}</p>
                </div>
                <div>
                    <a href="{% url 'urun:detay' urun.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Ürün Detayına Dön
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Mesajlar -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- Varyant Ekleme Formu -->
        <div class="col-md-5">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plus me-2"></i>Yeni Varyant Ekle
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="varyantForm">
                        {% csrf_token %}
                        
                        <!-- Varyasyon Seçimi -->
                        <div class="row">
                            {% if renkler %}
                            <div class="col-md-4 mb-3">
                                <label for="renk" class="form-label">Renk</label>
                                <select class="form-select" id="renk" name="renk">
                                    <option value="">Seçiniz</option>
                                    {% for renk in renkler %}
                                        <option value="{{ renk.id }}" data-hex="{{ renk.hex_kodu }}">{{ renk.deger }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            
                            {% if bedenler %}
                            <div class="col-md-4 mb-3">
                                <label for="beden" class="form-label">Beden</label>
                                <select class="form-select" id="beden" name="beden">
                                    <option value="">Seçiniz</option>
                                    {% for beden in bedenler %}
                                        <option value="{{ beden.id }}">{{ beden.deger }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                            
                            {% if diger_varyasyonlar %}
                            <div class="col-md-4 mb-3">
                                <label for="diger_varyasyon" class="form-label">Diğer</label>
                                <select class="form-select" id="diger_varyasyon" name="diger_varyasyon">
                                    <option value="">Seçiniz</option>
                                    {% for diger in diger_varyasyonlar %}
                                        <option value="{{ diger.id }}">{{ diger.deger }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Barkod -->
                        <div class="mb-3">
                            <label for="barkod" class="form-label">Barkod</label>
                            <input type="text" class="form-control" id="barkod" name="barkod" 
                                   placeholder="Boş bırakılırsa otomatik oluşturulur">
                        </div>

                        <!-- Fiyat Bilgileri -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="alis_fiyati" class="form-label">Alış Fiyatı</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="alis_fiyati" name="alis_fiyati" 
                                           step="0.01" min="0" placeholder="0.00">
                                    <span class="input-group-text">₺</span>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="kar_orani" class="form-label">Kar Oranı</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="kar_orani" name="kar_orani" 
                                           value="50" step="0.1" min="0" max="1000">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="satis_fiyati" class="form-label">Satış Fiyatı <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="satis_fiyati" name="satis_fiyati" 
                                           step="0.01" min="0.01" required placeholder="0.00">
                                    <span class="input-group-text">₺</span>
                                </div>
                            </div>
                        </div>

                        <!-- Stok -->
                        <div class="mb-3">
                            <label for="stok_miktari" class="form-label">Stok Miktarı</label>
                            <input type="number" class="form-control" id="stok_miktari" name="stok_miktari" 
                                   value="0" min="0" step="1">
                        </div>

                        <!-- Resim -->
                        <div class="mb-3">
                            <label for="resim" class="form-label">Varyant Resmi</label>
                            <input type="file" class="form-control" id="resim" name="resim" accept="image/*">
                            <div class="form-text">JPG, PNG, GIF formatları desteklenir. Maksimum 5MB.</div>
                        </div>

                        <!-- Ek Açıklama -->
                        <div class="mb-3">
                            <label for="ek_aciklama" class="form-label">Ek Açıklama</label>
                            <textarea class="form-control" id="ek_aciklama" name="ek_aciklama" rows="2" 
                                      placeholder="Bu varyanta özel açıklama..."></textarea>
                        </div>

                        <!-- Aktif Durumu -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="aktif" name="aktif" checked>
                                <label class="form-check-label" for="aktif">
                                    Aktif (Satışa hazır)
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-2"></i>Varyant Ekle
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Mevcut Varyantlar -->
        <div class="col-md-7">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>Mevcut Varyantlar ({{ varyantlar.count }})
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if varyantlar %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Resim</th>
                                        <th>Varyasyon</th>
                                        <th>Barkod</th>
                                        <th>Fiyat</th>
                                        <th>Stok</th>
                                        <th>Durum</th>
                                        <th width="100">İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for varyant in varyantlar %}
                                    <tr>
                                        <td>
                                            {% if varyant.resim %}
                                                <img src="{{ varyant.resim.url }}" alt="{{ varyant.varyasyon_adi }}" 
                                                     class="img-thumbnail" style="width: 40px; height: 40px; object-fit: cover;">
                                            {% else %}
                                                <div class="bg-light text-muted d-flex align-items-center justify-content-center" 
                                                     style="width: 40px; height: 40px; border-radius: 4px;">
                                                    <i class="fas fa-image"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="fw-bold">{{ varyant.varyasyon_adi }}</div>
                                            {% if varyant.ek_aciklama %}
                                                <small class="text-muted">{{ varyant.ek_aciklama|truncatechars:30 }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if varyant.barkod %}
                                                <code>{{ varyant.barkod }}</code>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="fw-bold text-success">{{ varyant.satis_fiyati }}₺</div>
                                            {% if varyant.alis_fiyati %}
                                                <small class="text-muted">Alış: {{ varyant.alis_fiyati }}₺</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if varyant.stok_miktari > 10 %}success{% elif varyant.stok_miktari > 0 %}warning{% else %}danger{% endif %}">
                                                {{ varyant.stok_miktari }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if varyant.aktif %}
                                                <span class="badge bg-success">Aktif</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Pasif</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-danger" 
                                                        onclick="varyantSil({{ varyant.id }}, '{{ varyant.varyasyon_adi|escapejs }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Henüz varyant eklenmemiş</h5>
                            <p class="text-muted">Sol taraftaki formu kullanarak ilk varyantı ekleyin.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Varyant Silme Modal -->
<div class="modal fade" id="varyantSilModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Varyant Sil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bu varyantı silmek istediğinizden emin misiniz?</p>
                <div class="alert alert-warning">
                    <strong>Dikkat:</strong> Bu işlem geri alınamaz. Varyanta ait tüm satış geçmişi korunacak ancak yeni satış yapılamayacaktır.
                </div>
                <div id="varyantBilgi"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <form method="post" id="varyantSilForm" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Sil
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Fiyat hesaplama
document.getElementById('alis_fiyati').addEventListener('input', hesaplaFiyat);
document.getElementById('kar_orani').addEventListener('input', hesaplaFiyat);

function hesaplaFiyat() {
    const alisFiyati = parseFloat(document.getElementById('alis_fiyati').value) || 0;
    const karOrani = parseFloat(document.getElementById('kar_orani').value) || 0;
    
    if (alisFiyati > 0 && karOrani > 0) {
        const satisFiyati = alisFiyati * (1 + karOrani / 100);
        document.getElementById('satis_fiyati').value = satisFiyati.toFixed(2);
    }
}

// Varyant silme
function varyantSil(varyantId, varyasyonAdi) {
    document.getElementById('varyantBilgi').innerHTML = 
        '<strong>Silinecek Varyant:</strong> ' + varyasyonAdi;
    document.getElementById('varyantSilForm').action = 
        '{% url "urun:varyant_sil" 0 %}'.replace('0', varyantId);
    
    new bootstrap.Modal(document.getElementById('varyantSilModal')).show();
}

// Form validasyonu
document.getElementById('varyantForm').addEventListener('submit', function(e) {
    const renk = document.getElementById('renk').value;
    const beden = document.getElementById('beden').value;
    const diger = document.getElementById('diger_varyasyon').value;
    
    if (!renk && !beden && !diger) {
        e.preventDefault();
        alert('En az bir varyasyon seçmelisiniz!');
        return false;
    }
    
    const satisFiyati = parseFloat(document.getElementById('satis_fiyati').value);
    if (!satisFiyati || satisFiyati <= 0) {
        e.preventDefault();
        alert('Geçerli bir satış fiyatı girmelisiniz!');
        return false;
    }
});

// Renk seçimi değiştiğinde hex kod gösterimi
document.getElementById('renk').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const hexKodu = selectedOption.getAttribute('data-hex');
    
    if (hexKodu && hexKodu !== 'None') {
        // Renk seçim kutusunun yanına renk örneği göster
        let colorPreview = document.getElementById('renk-preview');
        if (!colorPreview) {
            colorPreview = document.createElement('span');
            colorPreview.id = 'renk-preview';
            colorPreview.style.cssText = 'display: inline-block; width: 20px; height: 20px; border: 1px solid #ccc; margin-left: 8px; border-radius: 3px;';
            this.parentNode.appendChild(colorPreview);
        }
        colorPreview.style.backgroundColor = hexKodu;
        colorPreview.style.display = 'inline-block';
    } else {
        const colorPreview = document.getElementById('renk-preview');
        if (colorPreview) {
            colorPreview.style.display = 'none';
        }
    }
});
</script>
{% endblock %}
