{% extends 'base.html' %}

{% block title %}Barkod Sorgula{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4><i class="fas fa-barcode"></i> Barkod Sorgula</h4>
                </div>
                <div class="card-body">
                    <!-- Barkod Arama Formu -->
                    <form method="get" class="mb-4" id="barkodForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-barcode"></i>
                                    </span>
                                    <input type="text" class="form-control form-control-lg" name="barkod"
                                        id="barkodInput" value="{{ barkod|default:'' }}"
                                        placeholder="Barkod okutun veya yazÄ±n..." autofocus autocomplete="off">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-success btn-lg w-100" id="cameraBtn"
                                    title="Kamera ile Barkod Oku">
                                    <i class="fas fa-camera"></i>
                                    <span class="d-none d-md-inline">Kamera</span>
                                    <span class="d-md-none">ðŸ“·</span>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-search"></i> Sorgula
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Kamera AlanÄ± -->
                    <div class="row mb-4 d-none" id="cameraArea">
                        <div class="col-12">
                            <div class="card border-success">
                                <div
                                    class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-camera"></i> Kamera ile Barkod Okuma
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-light" id="stopCameraBtn">
                                        <i class="fas fa-times"></i> Kapat
                                    </button>
                                </div>
                                <div class="card-body p-2 text-center">
                                    <video id="preview" class="w-100 rounded"
                                        style="max-height: 400px; background: #000;"></video>
                                    <div class="mt-2">
                                        <div class="d-flex justify-content-center align-items-center">
                                            <div class="text-center">
                                                <h6><i class="fas fa-camera text-success"></i> Kamera Aktif</h6>
                                                <p class="small mb-2">ðŸ“± Mobil cihazlarda arka kamera otomatik
                                                    kullanÄ±lÄ±r</p>
                                                <p class="small mb-0">Barkodu kameraya doÄŸrultun, otomatik okuyacak</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Scan Result -->
                                <div class="alert alert-success mx-3 mb-3 d-none" id="scanResult">
                                    <i class="fas fa-check-circle"></i>
                                    Barkod okundu: <strong id="scannedCode"></strong>
                                    <br><small>Otomatik olarak arama yapÄ±lÄ±yor...</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SonuÃ§lar -->
                    {% if barkod %}
                    {% if urun %}
                    <!-- ÃœrÃ¼n Bulundu -->
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle"></i> ÃœrÃ¼n Bulundu!</h5>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            {% if urun.resim %}
                            <img src="{{ urun.resim.url }}" alt="{{ urun.ad }}" class="img-fluid rounded shadow">
                            {% else %}
                            <div class="bg-light d-flex align-items-center justify-content-center rounded shadow"
                                style="height: 300px;">
                                <i class="fas fa-image fa-5x text-muted"></i>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5><i class="fas fa-info-circle"></i> ÃœrÃ¼n Bilgileri</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td width="30%"><strong>ÃœrÃ¼n AdÄ±:</strong></td>
                                            <td>{{ urun.ad }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>ÃœrÃ¼n Kodu:</strong></td>
                                            <td><code>{{ urun.urun_kodu }}</code></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Kategori:</strong></td>
                                            <td>
                                                <span class="badge bg-info">
                                                    {{ urun.kategori.ad }}
                                                </span>
                                            </td>
                                        </tr>
                                        {% if urun.marka %}
                                        <tr>
                                            <td><strong>Marka:</strong></td>
                                            <td>
                                                <span class="badge bg-secondary">{{ urun.marka.ad }}</span>
                                            </td>
                                        </tr>
                                        {% endif %}
                                        <tr>
                                            <td><strong>SatÄ±ÅŸ FiyatÄ±:</strong></td>
                                            <td>
                                                <h5 class="text-success mb-0">{{ urun.satis_fiyati|floatformat:2 }} â‚º
                                                </h5>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Stok Durumu:</strong></td>
                                            <td>
                                                {% if urun.toplam_stok > 0 %}
                                                <span class="badge bg-success fs-6">
                                                    {{ urun.toplam_stok }} adet stokta
                                                </span>
                                                {% else %}
                                                <span class="badge bg-danger fs-6">Stokta yok</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% if urun.aciklama %}
                                        <tr>
                                            <td><strong>AÃ§Ä±klama:</strong></td>
                                            <td>{{ urun.aciklama }}</td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                </div>
                                <div class="card-footer">
                                    <div class="btn-group w-100">
                                        <a href="{% url 'urun:duzenle' urun.id %}" class="btn btn-warning">
                                            <i class="fas fa-edit"></i> DÃ¼zenle
                                        </a>
                                        <a href="{% url 'satis:ekrani' %}?barkod={{ urun.barkod }}"
                                            class="btn btn-success">
                                            <i class="fas fa-shopping-cart"></i> SatÄ±ÅŸ EkranÄ±na Ekle
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Varyasyonlar BÃ¶lÃ¼mÃ¼ -->
                        {% if varyantlar %}
                        <div class="col-12 mt-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5><i class="fas fa-palette"></i> ÃœrÃ¼n VaryasyonlarÄ± ({{ varyantlar|length }} adet)
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        {% for v in varyantlar %}
                                        <div class="col-lg-6 col-xl-4 mb-3">
                                            <div
                                                class="card variant-card {% if v == varyant %}border-primary{% endif %}">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <h6 class="mb-0">{{ v.varyasyon_adi }}</h6>
                                                        {% if v.stok_miktari == 0 %}
                                                        <span class="badge bg-danger">TÃ¼kendi</span>
                                                        {% elif v.stok_miktari <= 5 %} <span
                                                            class="badge bg-warning text-dark">Az Stok</span>
                                                            {% elif v.stok_miktari <= 20 %} <span class="badge bg-info">
                                                                Orta Stok</span>
                                                                {% else %}
                                                                <span class="badge bg-success">Stokta</span>
                                                                {% endif %}
                                                                {% if v == varyant %}
                                                                <span class="badge bg-primary ms-1">Aranan</span>
                                                                {% endif %}
                                                    </div>

                                                    <div class="row g-2 mb-2">
                                                        {% if v.renk %}
                                                        <div class="col-6">
                                                            <small class="text-muted">Renk</small>
                                                            <div class="fw-bold">{{ v.renk.ad }}</div>
                                                        </div>
                                                        {% endif %}
                                                        {% if v.beden %}
                                                        <div class="col-6">
                                                            <small class="text-muted">Beden</small>
                                                            <div class="fw-bold">{{ v.beden.ad }}</div>
                                                        </div>
                                                        {% endif %}
                                                    </div>

                                                    <div class="row g-2 mb-2">
                                                        <div class="col-6">
                                                            <small class="text-muted">Stok</small>
                                                            <div class="fw-bold text-primary">{{ v.stok_miktari }}
                                                                adet</div>
                                                        </div>
                                                        <div class="col-6">
                                                            <small class="text-muted">Fiyat</small>
                                                            <div class="fw-bold text-success">{{ v.urun.satis_fiyati|floatformat:2 }} â‚º</div>
                                                        </div>
                                                    </div>

                                                    {% if v.barkod %}
                                                    <div class="mb-2">
                                                        <small class="text-muted">Barkod</small>
                                                        <div class="font-monospace small">{{ v.barkod }}</div>
                                                    </div>
                                                    {% endif %}

                                                    <div class="d-grid gap-2">
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="{% url 'satis:ekrani' %}?barkod={{ v.barkod }}"
                                                                class="btn btn-success" title="SatÄ±ÅŸ EkranÄ±na Ekle">
                                                                <i class="fas fa-shopping-cart"></i> SatÄ±ÅŸ
                                                            </a>
                                                            <button type="button" class="btn btn-success"
                                                                title="Etiket YazdÄ±r" onclick="printLabel({{ v.id }})">
                                                                <i class="fas fa-print"></i> Etiket
                                                            </button>
                                                            <button type="button" class="btn btn-outline-primary"
                                                                onclick="copyToClipboard('{{ v.barkod }}')"
                                                                title="Barkodu Kopyala">
                                                                <i class="fas fa-copy"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% else %}
                        <!-- ÃœrÃ¼n BulunamadÄ± -->
                        <div class="alert alert-warning">
                            <h5><i class="fas fa-exclamation-triangle"></i> ÃœrÃ¼n BulunamadÄ±!</h5>
                            <p>{{ barkod }} barkoduna ait Ã¼rÃ¼n sistemde kayÄ±tlÄ± deÄŸil.</p>
                            <hr>
                            <a href="{% url 'urun:ekle' %}?barkod={{ barkod }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Bu Barkod ile Yeni ÃœrÃ¼n Ekle
                            </a>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block extra_css %}
    <style>
        /* Video element stil dÃ¼zeltmesi */
        #preview {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* Barkod input stili */
        #barkodInput {
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        /* Kamera butonu hover efekti */
        #cameraBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            transition: all 0.3s ease;
        }

        /* Scan result animasyonu */
        #scanResult {
            animation: slideInUp 0.5s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Kamera alanÄ± animasyonu */
        #cameraArea {
            animation: fadeInScale 0.5s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Mobil uyumluluk */
        @media (max-width: 768px) {
            #preview {
                max-height: 300px;
            }

            .card-body {
                padding: 1rem 0.5rem;
            }
        }


        /* Varyasyon kartlarÄ± */
        .variant-card {
            transition: all 0.3s ease;
            height: 100%;
        }

        .variant-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .variant-card.border-primary {
            border-width: 2px !important;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* ZXing kamera stilleri */
        #preview {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: scaleX(-1);
            /* Ayna gÃ¶rÃ¼nÃ¼mÃ¼ */
        }
    </style>
    {% endblock %}

    {% block extra_js %}
    <!-- ZXing-js KÃ¼tÃ¼phanesi - Android uyumlu versiyon -->
    <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

    <script>

        // Barkod kopyalama fonksiyonu
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function () {
                // Toast bildirim gÃ¶ster
                const toast = document.createElement('div');
                toast.className = 'position-fixed top-0 end-0 p-3';
                toast.style.zIndex = '9999';
                toast.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong class="me-auto">BaÅŸarÄ±lÄ±</strong>
                </div>
                <div class="toast-body">
                    Barkod kopyalandÄ±: ${text}
                </div>
            </div>
        `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            }).catch(function (err) {
                alert('Kopyalama baÅŸarÄ±sÄ±z: ' + err);
            });
        }

        // Kamera deÄŸiÅŸkenleri
        let isScanning = false;
        let codeReader = null;
        let selectedDeviceId = null;
        let cameraDevices = [];

        document.addEventListener('DOMContentLoaded', function () {
            const barkodInput = document.getElementById('barkodInput');
            const cameraBtn = document.getElementById('cameraBtn');
            const cameraArea = document.getElementById('cameraArea');
            const stopCameraBtn = document.getElementById('stopCameraBtn');
            const scanResult = document.getElementById('scanResult');
            const scannedCode = document.getElementById('scannedCode');
            const barkodForm = document.getElementById('barkodForm');

            // Enter tuÅŸu ile otomatik arama
            barkodInput.addEventListener('keyup', function (e) {
                if (e.key === 'Enter') {
                    barkodForm.submit();
                }
            });

            // Kamera butonuna tÄ±klama
            cameraBtn.addEventListener('click', function () {
                console.log('Kamera butonu tÄ±klandÄ±, isScanning:', isScanning);
                if (!isScanning) {
                    startCamera();
                }
            });

            // KamerayÄ± durdur butonu
            stopCameraBtn.addEventListener('click', function () {
                stopCamera();
            });

            async function startCamera() {
                console.log('startCamera fonksiyonu baÅŸlatÄ±ldÄ±');
                try {
                    // Device detection
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    const isAndroid = /Android/i.test(navigator.userAgent);
                    const isMobile = isIOS || isAndroid || /webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                    console.log('Device detection:', { isIOS, isAndroid, isMobile });

                    // Kamera izni kontrolÃ¼
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        alert('Kamera bu cihazda desteklenmiyor.');
                        return;
                    }

                    cameraArea.classList.remove('d-none');
                    cameraBtn.disabled = true;
                    cameraBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="d-none d-md-inline">BaÅŸlatÄ±lÄ±yor...</span>';

                    // ZXing kÃ¼tÃ¼phanesini baÅŸlat
                    codeReader = new ZXing.BrowserMultiFormatReader();

                    // iOS ve Android iÃ§in farklÄ± kamera listesi alma stratejileri
                    let videoInputDevices = [];
                    try {
                        if (isIOS) {
                            // iOS iÃ§in Ã¶zel handling
                            console.log('iOS cihaz algÄ±landÄ±, Ã¶zel kamera listesi alÄ±nÄ±yor...');

                            // iOS Safari iÃ§in navigator.mediaDevices.enumerateDevices() daha gÃ¼venilir
                            const devices = await navigator.mediaDevices.enumerateDevices();
                            videoInputDevices = devices.filter(device => device.kind === 'videoinput');

                            console.log('iOS kameralar:', videoInputDevices);

                        } else {
                            // Android ve diÄŸer platformlar iÃ§in normal API
                            videoInputDevices = await codeReader.listVideoInputDevices();
                        }
                    } catch (err) {
                        console.log('Kamera listesi alma hatasÄ±, fallback yÃ¶ntem:', err);
                        // Fallback: navigator.mediaDevices kullan
                        try {
                            const devices = await navigator.mediaDevices.enumerateDevices();
                            videoInputDevices = devices.filter(device => device.kind === 'videoinput');
                        } catch (fallbackErr) {
                            console.log('Fallback da baÅŸarÄ±sÄ±z, varsayÄ±lan kamerayÄ± kullan');
                            videoInputDevices = [{ deviceId: 'default', label: 'VarsayÄ±lan Kamera' }];
                        }
                    }

                    cameraDevices = videoInputDevices;

                    if (cameraDevices.length === 0) {
                        throw new Error('HiÃ§ kamera bulunamadÄ±');
                    }

                    console.log('Bulunan kameralar:', cameraDevices.map(d => ({ id: d.deviceId, label: d.label })));

                    // iOS ve Android iÃ§in farklÄ± kamera seÃ§im stratejileri
                    if (isIOS) {
                        // iOS iÃ§in arka kamera seÃ§imi (genelde son kamera arka kameradÄ±r)
                        selectedDeviceId = cameraDevices.find(device =>
                            device.label && (
                                device.label.toLowerCase().includes('back') ||
                                device.label.toLowerCase().includes('rear') ||
                                device.label.toLowerCase().includes('environment') ||
                                device.label.toLowerCase().includes('wide') ||  // iOS'ta genelde "Wide" arka kamera
                                device.label.toLowerCase().includes('main')     // BazÄ± iOS cihazlarda "Main Camera"
                            )
                        )?.deviceId;

                        // iOS'ta genelde son indeksteki kamera arka kameradÄ±r
                        if (!selectedDeviceId && cameraDevices.length > 1) {
                            selectedDeviceId = cameraDevices[cameraDevices.length - 1].deviceId;
                        } else if (!selectedDeviceId) {
                            selectedDeviceId = cameraDevices[0].deviceId;
                        }

                    } else if (isAndroid) {
                        // Android iÃ§in arka kamera seÃ§imi
                        selectedDeviceId = cameraDevices.find(device =>
                            device.label && (
                                device.label.toLowerCase().includes('back') ||
                                device.label.toLowerCase().includes('rear') ||
                                device.label.toLowerCase().includes('environment') ||
                                device.label.toLowerCase().includes('arka')
                            )
                        )?.deviceId;

                        // Arka kamera bulunamazsa son kamerayÄ± kullan
                        if (!selectedDeviceId) {
                            selectedDeviceId = cameraDevices[cameraDevices.length - 1].deviceId;
                        }
                    } else {
                        // MasaÃ¼stÃ¼ iÃ§in ilk kamerayÄ± kullan
                        selectedDeviceId = cameraDevices[0].deviceId;
                    }

                    console.log('SeÃ§ilen kamera ID:', selectedDeviceId);

                    // iOS ve Android iÃ§in optimize edilmiÅŸ constraints
                    const constraints = {
                        video: {
                            deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                            // iOS iÃ§in facingMode environment daha gÃ¼venilir
                            facingMode: (isIOS || isAndroid) ? 'environment' : 'user',
                            width: { ideal: isIOS ? 1920 : 1280 },  // iOS daha yÃ¼ksek Ã§Ã¶zÃ¼nÃ¼rlÃ¼k destekler
                            height: { ideal: isIOS ? 1080 : 720 },
                            frameRate: { ideal: 30, max: 30 }       // iOS iÃ§in frame rate sÄ±nÄ±rÄ±
                        }
                    };

                    console.log('KullanÄ±lacak constraints:', constraints);

                    // KamerayÄ± baÅŸlat - iOS/Android uyumlu yÃ¶ntem
                    try {
                        if (isIOS) {
                            // iOS iÃ§in Ã¶nce getUserMedia ile test et
                            const stream = await navigator.mediaDevices.getUserMedia(constraints);
                            stream.getTracks().forEach(track => track.stop()); // Test stream'i kapat
                        }

                        await codeReader.decodeFromVideoDevice(selectedDeviceId, 'preview', (result, err) => {
                            if (result) {
                                console.log('Barkod okundu:', result.text);
                                onBarcodeDetected(result.text);
                            }
                            if (err && !(err instanceof ZXing.NotFoundException)) {
                                console.log('Okuma hatasÄ±:', err);
                            }
                        });

                    } catch (decodeErr) {
                        console.log('Decode hatasÄ±, iOS/Android fallback yÃ¶ntemi:', decodeErr);

                        if (isIOS) {
                            // iOS fallback: basit constraints
                            await codeReader.decodeFromVideoDevice(undefined, 'preview', (result, err) => {
                                if (result) {
                                    console.log('Barkod okundu:', result.text);
                                    onBarcodeDetected(result.text);
                                }
                                if (err && !(err instanceof ZXing.NotFoundException)) {
                                    console.log('Okuma hatasÄ±:', err);
                                }
                            });
                        } else {
                            // Android fallback
                            await codeReader.decodeFromVideoDevice(undefined, 'preview', (result, err) => {
                                if (result) {
                                    console.log('Barkod okundu:', result.text);
                                    onBarcodeDetected(result.text);
                                }
                                if (err && !(err instanceof ZXing.NotFoundException)) {
                                    console.log('Okuma hatasÄ±:', err);
                                }
                            });
                        }
                    }

                    isScanning = true;
                    cameraBtn.innerHTML = '<i class="fas fa-camera"></i> <span class="d-none d-md-inline">Kamera AÃ§Ä±k</span>';
                    cameraBtn.classList.remove('btn-success');
                    cameraBtn.classList.add('btn-warning');

                    // iOS iÃ§in Ã¶zel uyarÄ±
                    if (isIOS) {
                        console.log('ðŸ“± iOS cihazÄ±nda en iyi sonuÃ§ iÃ§in kamerayÄ± barkoda yaklaÅŸtÄ±rÄ±n');
                    }

                    console.log('Kamera baÅŸarÄ±yla baÅŸlatÄ±ldÄ±');

                } catch (err) {
                    console.error('Kamera baÅŸlatma hatasÄ±:', err);
                    let errorMessage = 'Kamera baÅŸlatÄ±lamadÄ±';

                    if (err.name === 'NotAllowedError') {
                        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                            errorMessage = 'ðŸ“± iOS: Ayarlar â†’ Safari â†’ Kamera eriÅŸimine izin verin ve sayfayÄ± yenileyin.';
                        } else {
                            errorMessage = 'Kamera izni reddedildi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±nÄ±zdan kamera eriÅŸimine izin verin.';
                        }
                    } else if (err.name === 'NotFoundError') {
                        errorMessage = 'Kamera bulunamadÄ±. CihazÄ±nÄ±zda kamera olduÄŸundan emin olun.';
                    } else if (err.name === 'NotSupportedError') {
                        errorMessage = 'TarayÄ±cÄ±nÄ±z kamera Ã¶zelliÄŸini desteklemiyor.';
                    } else if (err.name === 'NotReadableError') {
                        errorMessage = 'Kamera kullanÄ±mda. DiÄŸer uygulamalarÄ± kapatÄ±p tekrar deneyin.';
                    } else if (err.message) {
                        errorMessage = err.message;
                    }

                    alert(errorMessage);
                    stopCamera();
                }
            }

            function onBarcodeDetected(code) {
                console.log("Barkod okundu:", code);

                // TitreÅŸim efekti (mobil cihazlarda)
                if (navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }

                // Sonucu gÃ¶ster
                scannedCode.textContent = code;
                scanResult.classList.remove('d-none');

                // Input'a yaz
                barkodInput.value = code;

                // KamerayÄ± durdur
                stopCamera();

                // Otomatik arama yap
                setTimeout(() => {
                    barkodForm.submit();
                }, 1500);
            }

            function stopCamera() {
                if (isScanning && codeReader) {
                    codeReader.reset();
                    isScanning = false;
                }

                cameraArea.classList.add('d-none');
                cameraBtn.disabled = false;
                cameraBtn.innerHTML = '<i class="fas fa-camera"></i> <span class="d-none d-md-inline">Kamera</span><span class="d-md-none">ðŸ“·</span>';
                cameraBtn.classList.remove('btn-warning');
                cameraBtn.classList.add('btn-success');
                scanResult.classList.add('d-none');

                // Input'a odaklan
                setTimeout(() => {
                    barkodInput.focus();
                }, 300);
            }

            // Sayfa kapatÄ±lÄ±rken kamerayÄ± durdur
            window.addEventListener('beforeunload', function () {
                stopCamera();
            });

            // Barkod input'una odaklan
            if (barkodInput) {
                barkodInput.focus();
            }

            // Etiket yazdÄ±rma fonksiyonu - Aktif
            window.printLabel = function (varyantId) {
                console.log('Etiket yazdÄ±rma baÅŸlatÄ±lÄ±yor, varyant ID:', varyantId);
                
                // Loading gÃ¶stergesi
                const printBtn = event.target.closest('button');
                const originalText = printBtn.innerHTML;
                printBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                printBtn.disabled = true;
                
                // API'den ZPL etiket kodunu al
                fetch(`/api/varyant-etiket/${varyantId}/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(zplCode => {
                    if (!zplCode || zplCode.trim().length === 0) {
                        throw new Error('Etiket verisi alÄ±namadÄ±!');
                    }
                    
                    // ZPL kodunu yazdÄ±rma iÃ§in hazÄ±rla
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head>
                                <title>Etiket YazdÄ±r</title>
                                <style>
                                    body { margin: 0; padding: 0; }
                                    @media print {
                                        body { margin: 0; }
                                        @page { margin: 0; }
                                    }
                                </style>
                            </head>
                            <body>
                                <pre style="font-family: monospace; font-size: 12px; white-space: pre-wrap;">${zplCode}</pre>
                                <script>
                                    window.onload = function() {
                                        // Otomatik yazdÄ±rma
                                        setTimeout(function() {
                                            window.print();
                                            setTimeout(function() {
                                                window.close();
                                            }, 1000);
                                        }, 500);
                                    };
                                </script>
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                    
                    // BaÅŸarÄ± mesajÄ±
                    showToast('Etiket yazdÄ±rma penceresi aÃ§Ä±ldÄ±!', 'success');
                    
                })
                .catch(error => {
                    console.error('Etiket yazdÄ±rma hatasÄ±:', error);
                    showToast(`Etiket yazdÄ±rma hatasÄ±: ${error.message}`, 'error');
                })
                .finally(() => {
                    // Butonu eski haline getir
                    printBtn.innerHTML = originalText;
                    printBtn.disabled = false;
                });
            };
            
            // Toast bildirim fonksiyonu
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = 'position-fixed top-0 end-0 p-3';
                toast.style.zIndex = '9999';
                
                const bgClass = type === 'success' ? 'bg-success' : 
                               type === 'error' ? 'bg-danger' : 'bg-info';
                const icon = type === 'success' ? 'fa-check-circle' : 
                           type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
                
                toast.innerHTML = `
                    <div class="toast show" role="alert">
                        <div class="toast-header ${bgClass} text-white">
                            <i class="fas ${icon} me-2"></i>
                            <strong class="me-auto">${type === 'success' ? 'BaÅŸarÄ±lÄ±' : type === 'error' ? 'Hata' : 'Bilgi'}</strong>
                        </div>
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 4000);
            }
        });
    </script>
    {% endblock %}
    <!-- Cache Buster: v3.0 -->
    -->