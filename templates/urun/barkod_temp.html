{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    /* ANA CONTAINER - DİNAMİK VE ESNEKLİK - OVERFLOW SİLİNDİ */
    .sales-screen {
        min-height: 100vh;
        height: auto;
        overflow: visible;
        padding: 15px;
        display: flex;
        flex-direction: column;
    }
    
    /* SOL VE SAĞ PANEL ESNEKLİK - OVERFLOW YÖNETİMİ */
    .row.h-100 {
        min-height: calc(100vh - 30px);
        height: auto;
        display: flex;
        align-items: stretch;
        margin: 0;
        flex: 1;
    }
    
    .col-lg-8, .col-lg-4 {
        min-height: calc(100vh - 30px);
        height: auto;
        display: flex;
        flex-direction: column;
        padding: 0 7.5px;
        overflow: visible;
    }
    
    .barcode-section {
        background: linear-gradient(135deg, #4f72ff 0%, #3b5bff 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(79, 114, 255, 0.3);
        flex-shrink: 0;
    }
    
    .customer-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        flex-shrink: 0;
    }
    
    /* SEPET SEKSİYONU - DİNAMİK YÜKSEKLİK */
    .cart-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        flex: 1;
        min-height: 400px;
        height: auto;
        overflow: visible;
        display: flex;
        flex-direction: column;
    }
    
    .cart-container {
        flex: 1;
        height: auto;
        overflow: visible;
        max-height: none;
        padding: 1rem;
    }

    /* Sepet Container - Esnek yapı */
    #sepetContainer {
        flex: 1;
        overflow: visible;
        height: auto;
        min-height: 200px;
        padding: 1rem;
    }
    
    /* ÖDEME SEKSİYONU - DİNAMİK VE ESNEKLİK */
    .payment-simple {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-top: 1rem;
        height: auto;
        min-height: auto;
        overflow: visible;
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    
    .payment-simple-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
        background: #f8f9fa;
        border-radius: 8px 8px 0 0;
        flex-shrink: 0;
    }
    
    .payment-simple-content {
        padding: 1rem;
        flex: 1;
        height: auto;
        overflow: visible;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .payment-simple-footer {
        padding: 1rem;
        background: #28a745;
        color: white;
        border-radius: 0 0 8px 8px;
        margin-top: auto;
        flex-shrink: 0;
        display: block !important;
        visibility: visible !important;
    }
    
    .payment-simple-footer .btn {
        color: white;
        border-color: white;
        font-weight: bold;
    }
    
    .payment-simple-footer .btn:hover {
        background: rgba(255,255,255,0.2);
    }
    
    .daily-summary {
        flex-shrink: 0;
        padding: 1rem;
        background: #e9ecef;
        border-top: 1px solid #dee2e6;
        order: 99;
    }
    
    .payment-detail-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: #f8f9fa;
        height: auto;
        overflow: visible;
    }
    
    .karma-section {
        border-color: #ffc107 !important;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%) !important;
        height: auto !important;
        max-height: none !important;
        overflow: visible !important;
    }
    
    .payment-input-group {
        background: white;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }
    
    /* Karma Ödeme Animasyonları - ESNEKLİK */
    .payment-section-new.karma-active {
        height: auto;
        min-height: calc(100vh - 10px);
        display: flex;
        flex-direction: column;
    }
    
    .payment-section-new.karma-active .payment-body {
        height: auto;
        max-height: none;
        overflow: visible;
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .payment-section-new .payment-footer {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .karma-section {
        animation: slideInDown 0.5s ease-out;
    }
    
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .karma-summary {
        background: white;
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1rem;
    }
    
    .karma-ozet {
        background: white;
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #28a745;
        margin-top: 1rem;
    }
    
    .summary-section {
        background: linear-gradient(135deg, #ff7b7b 0%, #ff9500 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(255, 123, 123, 0.3);
    }
    
    .total-display {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin: 1rem 0;
    }
    
    .cart-item {
        border-bottom: 1px solid #eee;
        padding: 0.5rem;
        transition: background-color 0.2s;
    }
    
    .cart-item:hover {
        background-color: #f8f9fa;
    }
    
    /* ÖDEME BUTONLARI - MODERN TASARIM */
    .btn-payment {
        min-height: 70px;
        font-size: 1rem;
        margin-bottom: 0.5rem;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        font-weight: 600;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .btn-payment:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        border-color: rgba(255,255,255,0.3);
    }
    
    .btn-payment.active {
        border: 2px solid #fff;
        box-shadow: 0 4px 25px rgba(0,0,0,0.2), inset 0 2px 10px rgba(255,255,255,0.2);
        transform: scale(1.02);
        z-index: 10;
    }
    
    /* ÖDEME YÖNTEMİ RENKLERİ - YENİ PALET */
    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border-color: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #20c997 0%, #28a745 100%);
        border-color: #20c997;
    }
    
    .btn-success.active {
        background: linear-gradient(135deg, #1e7e34 0%, #17a2b8 100%) !important;
        border-color: #fff !important;
        box-shadow: 0 0 25px rgba(40, 167, 69, 0.4);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #6610f2 100%);
        border-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #6610f2 0%, #007bff 100%);
        border-color: #6610f2;
    }
    
    .btn-primary.active {
        background: linear-gradient(135deg, #0056b3 0%, #5a0bd1 100%) !important;
        border-color: #fff !important;
        box-shadow: 0 0 25px rgba(0, 123, 255, 0.4);
    }
    
    .btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        border-color: #17a2b8;
        color: white;
    }
    
    .btn-info:hover {
        background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        border-color: #20c997;
    }
    
    .btn-info.active {
        background: linear-gradient(135deg, #138496 0%, #1aa67f 100%) !important;
        border-color: #fff !important;
        box-shadow: 0 0 25px rgba(23, 162, 184, 0.4);
    }
    
    .btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        border-color: #ffc107;
        color: #212529;
    }
    
    .btn-warning:hover {
        background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
        border-color: #fd7e14;
        color: #212529;
    }
    
    .btn-warning.active {
        background: linear-gradient(135deg, #e0a800 0%, #e55a4f 100%) !important;
        border-color: #fff !important;
        color: #fff !important;
        box-shadow: 0 0 25px rgba(255, 193, 7, 0.4);
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        border-color: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
        border-color: #495057;
    }
    
    .btn-secondary.active {
        background: linear-gradient(135deg, #545b62 0%, #343a40 100%) !important;
        border-color: #fff !important;
        box-shadow: 0 0 25px rgba(108, 117, 125, 0.4);
    }
    
    /* AKTİF BUTON İŞARETÇİSİ - MODERN */
    .btn-payment.active::before {
        content: '✓';
        position: absolute;
        top: -8px;
        right: -8px;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
        border: 3px solid white;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        animation: checkmarkPulse 2s infinite;
    }
    
    @keyframes checkmarkPulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    /* FOOTER BUTONLARI - MODERN HOVER EFEKTLERİ */
    .modern-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(0,0,0,0.15) !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    }
    
    .modern-outline-btn:hover {
        background: rgba(255,255,255,0.15) !important;
        border-color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255,255,255,0.2);
    }
    
    .modern-action-btn:disabled {
        opacity: 0.6;
        transform: none !important;
        box-shadow: none !important;
    }
    
    /* SEPET TEMİZLE BUTONU */
    .modern-danger-btn:hover {
        background: #dc3545 !important;
        border-color: #dc3545 !important;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
    }
    
    /* AKSİYON BUTONLARI PANELİ - YEŞİL TEMA */
    .action-buttons-panel {
        animation: slideInUp 0.5s ease-out;
    }
    
    .action-buttons-panel .modern-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(0,0,0,0.15) !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    }
    
    .action-buttons-panel .modern-outline-btn:hover {
        background: rgba(255,255,255,0.15) !important;
        border-color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255,255,255,0.3);
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes pulse {
        0% { transform: scale(1.05); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1.05); }
    }
    
    .payment-methods {
        position: relative;
    }
    
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        border-radius: 0 0 10px 10px;
    }
    
    .search-item {
        padding: 0.75rem;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .search-item:hover {
        background-color: #f8f9fa;
    }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .quantity-btn {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 5px;
        background: #007bff;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
    
    .quantity-input {
        width: 60px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 0.25rem;
    }
    
    .payment-methods {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
        .payment-methods {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    .empty-cart {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .empty-cart i {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    /* ESKİ CSS'LER KALDIRILDI - YENİ TASARIM KULLANILIYOR */
    
    /* Satış tamamlama butonu karma ödeme durumunda */
    .satis-tamamla-container {
        margin-top: 1rem;
    }
    
    .payment-section.karma-active {
        height: calc(100vh - 10px);
        overflow: hidden;
        transition: all 0.4s ease;
        animation: expandPaymentSection 0.4s ease-out;
        display: flex;
        flex-direction: column;
    }
    
    .payment-section.karma-active .payment-content {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 1rem;
    }
    
    .payment-section.karma-active .satis-tamamla-container {
        flex-shrink: 0 !important;
        background: #f8f9fa !important;
        padding: 1.5rem !important;
        border-top: 3px solid #28a745 !important;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.2) !important;
        z-index: 1000 !important;
        display: block !important;
        position: relative !important;
        margin-top: 0 !important;
        width: 100% !important;
    }
    
    @keyframes expandPaymentSection {
        from {
            height: calc(50vh);
        }
        to {
            height: calc(100vh - 10px);
        }
    }
    
    @keyframes expandPayment {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .payment-section.karma-active .payment-content {
        overflow: visible;
        display: block;
    }
    
    .karma-odeme-detay {
        margin-top: 1rem;
        border-radius: 8px;
        background: #f8f9fa;
        transition: all 0.3s ease;
        animation: slideDown 0.4s ease-out, expandPayment 0.4s ease-out;
        border: 1px solid #28a745;
        padding: 1rem;
        height: auto;
        overflow: visible;
        flex-shrink: 0;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Karma ödeme tutar özeti */
    .odeme-tutar-ozet {
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Ödeme özeti alanı */
    .odeme-ozeti {
        background: #f8f9fa !important;
        border-top: 1px solid #dee2e6;
        margin-top: 1rem;
        padding: 1rem !important;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
    }
    
    /* Zorunlu alan stilleri */
    .required-field {
        border: 2px solid #dc3545 !important;
        box-shadow: 0 0 0 0.1rem rgba(220, 53, 69, 0.25) !important;
    }
    
    .required-field:focus {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    
    /* Responsive ayarlar - ESNEKLİK */
    @media (max-height: 800px) {
        .payment-section {
            min-height: calc(100vh - 80px);
            height: auto;
        }
        
        .cart-section {
            min-height: calc(100vh - 80px);
            height: auto;
        }
        
        .payment-section.karma-active {
            min-height: calc(100vh - 10px);
            height: auto;
        }
        
        .karma-odeme-detay {
            height: auto;
            overflow: visible;
        }
    }
    
    @media (max-height: 600px) {
        .payment-section {
            min-height: calc(100vh - 50px);
            height: auto;
        }
        
        .cart-section {
            min-height: calc(100vh - 50px);
            height: auto;
        }
        
        .payment-section.karma-active {
            min-height: calc(100vh - 5px);
            height: auto;
        }
        
        .karma-odeme-detay {
            height: auto;
            overflow: visible;
        }
    }
    
    /* Kamera CSS */
    .camera-container {
        position: relative;
        background: #000;
        border-radius: 8px;
        overflow: hidden;
    }
    
    #satisPreview {
        width: 100%;
        max-height: 300px;
        object-fit: cover;
        border-radius: 8px;
        /* iOS Safari için özel ayarlar */
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        -webkit-perspective: 1000px;
        perspective: 1000px;
    }
    
    /* iOS için özel responsive ayarlar */
    @media screen and (-webkit-min-device-pixel-ratio: 2) {
        #satisPreview {
            max-height: 350px;
        }
    }
    
    /* iPhone için özel ayarlar */
    @media only screen 
    and (min-device-width: 375px) 
    and (max-device-width: 812px) 
    and (-webkit-min-device-pixel-ratio: 3) {
        #satisPreview {
            max-height: 280px;
        }
        
        .camera-overlay {
            width: 180px;
            height: 90px;
        }
    }
    
    .camera-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 100px;
        border: 2px solid #00ff00;
        border-radius: 8px;
        pointer-events: none;
        z-index: 10;
    }
    
    .camera-overlay::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border: 2px dashed rgba(0, 255, 0, 0.5);
        border-radius: 8px;
        animation: scan-line 2s linear infinite;
    }
    
    @keyframes scan-line {
        0% { border-color: rgba(0, 255, 0, 0.8); }
        50% { border-color: rgba(0, 255, 0, 0.3); }
        100% { border-color: rgba(0, 255, 0, 0.8); }
    }
    
    .barcode-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        animation: success-pulse 0.5s ease-in-out;
    }
    
    @keyframes success-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid sales-screen">
    <div class="row h-100">
        <!-- Sol Panel - Ürün Arama ve Sepet -->
        <div class="col-lg-8">
            <!-- Barkod Okuyucu -->
            <div class="barcode-section">
                <h5 class="mb-3">
                    <i class="fas fa-barcode me-2"></i>
                    Satış Ekranı
                    <span class="float-end">Sipariş No: {{ siparis_no }}</span>
                </h5>
                <div class="row">
                    <div class="col-md-5">
                        <label class="form-label">Barkod Okuyucu</label>
                        <div class="input-group">
                            <input type="text" id="barkodInput" class="form-control form-control-lg" 
                                   placeholder="Barkod okutun veya yazın..." autofocus>
                            <button type="button" class="btn btn-success" id="satisKameraBtn" title="Kamera ile Barkod Oku">
                                <i class="fas fa-camera"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <label class="form-label">Ürün Ara</label>
                        <div class="position-relative">
                            <input type="text" id="urunAramaInput" class="form-control form-control-lg" 
                                   placeholder="Ürün adı ile ara...">
                            <div id="aramaContainer" class="search-results" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Kamera Alanı -->
                <div class="row mt-3 d-none" id="satisKameraArea">
                    <div class="col-12">
                        <div class="bg-white p-3 rounded">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="camera-container">
                                        <video id="satisPreview" 
                                               autoplay 
                                               playsinline 
                                               webkit-playsinline 
                                               muted
                                               style="transform: scaleX(-1);"></video>
                                        <div class="camera-overlay"></div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="text-dark">
                                        <h6 class="text-success">
                                            <i class="fas fa-camera me-2"></i>Kamera Aktif
                                        </h6>
                                        <p class="small mb-3">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Barkodu yeşil çerçeve içine getirin
                                        </p>
                                        
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-danger btn-sm" id="satisStopCamera">
                                                <i class="fas fa-stop me-1"></i>Kamerayı Durdur
                                            </button>
                                            
                                            <button type="button" class="btn btn-secondary btn-sm" id="satisSwitchCamera">
                                                <i class="fas fa-sync me-1"></i>Kamerayı Değiştir
                                            </button>
                                        </div>
                                        
                                        <div id="satisScanResult" class="alert alert-success mt-3 d-none">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <div>
                                                    <small><strong>Barkod Okundu:</strong></small><br>
                                                    <code id="satisScannedCode"></code>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                <strong>İpuçları:</strong><br>
                                                • Barkodu düz tutun<br>
                                                • Yeterli ışık sağlayın<br>
                                                • Kamerayı sabit tutun
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Müşteri Seçimi -->
            <div class="customer-section">
                <h6><i class="fas fa-user me-2"></i>Müşteri <span class="text-danger">*</span></h6>
                <div class="row">
                    <div class="col-md-8">
                        <div class="position-relative">
                            <input type="text" id="musteriAramaInput" class="form-control" 
                                   placeholder="Müşteri adı, telefon veya firma ara..."
                                   value="{% if secili_musteri %}{{ secili_musteri.ad }} {{ secili_musteri.soyad }}{% endif %}">
                            <div id="musteriAramaContainer" class="search-results" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <span id="secilenMusteri" class="form-control-plaintext">
                            {% if secili_musteri %}
                                <strong>{{ secili_musteri.ad }} {{ secili_musteri.soyad }}</strong><br>
                                <small>{{ secili_musteri.telefon }}</small>
                            {% else %}
                                <em>Müşteri seçili değil</em>
                            {% endif %}
                        </span>
                    </div>
                </div>
                <input type="hidden" id="musteriId" value="{% if secili_musteri %}{{ secili_musteri.id }}{% endif %}">
            </div>

            <!-- Sepet -->
            <div class="cart-section">
                <div class="p-3 border-bottom bg-light flex-shrink-0">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Sepet
                        <button class="btn btn-sm btn-outline-danger float-end modern-danger-btn" id="sepetTemizleBtn" style="border-radius: 8px; font-weight: 500; transition: all 0.3s ease;">
                            <i class="fas fa-trash me-1"></i> Sepeti Temizle
                        </button>
                    </h5>
                </div>
                <div id="sepetContainer" class="flex-grow-1">
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Sepet boş. Ürün eklemek için barkod okutun veya ürün arayın.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sağ Panel - Satış Özeti ve Ödeme -->
        <div class="col-lg-4">
            <!-- Satış Özeti -->
            <div class="summary-section">
                <h5><i class="fas fa-calculator me-2"></i>Satış Özeti</h5>
                <div class="d-flex justify-content-between">
                    <span>Toplam Ürün:</span>
                    <span id="toplamUrun">0</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Toplam Miktar:</span>
                    <span id="toplamMiktar">0</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Ara Toplam:</span>
                    <span id="araToplam">₺0,00</span>
                </div>
                <div class="d-flex justify-content-between" id="urunIndirimSatiri" style="display: none !important;">
                    <span>Ürün İndirimleri:</span>
                    <span id="urunIndirimTutari" class="text-warning">-₺0,00</span>
                </div>
                <div class="d-flex justify-content-between" id="genelIndirimSatiri" style="display: none !important;">
                    <span>Genel İndirim:</span>
                    <span id="genelIndirimTutari" class="text-danger">-₺0,00</span>
                </div>
                <hr>
                <div class="total-display">
                    <span id="genelToplam">₺0,00</span>
                </div>
            </div>

            <!-- Aksiyon Butonları Paneli -->
            <div class="action-buttons-panel" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                <div class="d-grid gap-3">
                    <button class="btn btn-light btn-lg modern-action-btn" id="satisTamamlaBtn" style="border-radius: 12px; font-weight: 600; padding: 12px 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s ease;">
                        <i class="fas fa-check me-2"></i> Satışı Tamamla
                    </button>
                    <button class="btn btn-outline-light modern-outline-btn" id="genelIndirimuygula" style="border-radius: 12px; font-weight: 600; padding: 10px 20px; border: 2px solid rgba(255,255,255,0.8); transition: all 0.3s ease;">
                        <i class="fas fa-percent me-2"></i> Genel İndirim Uygula
                    </button>
                </div>
            </div>

            <!-- Ödeme Yöntemleri - BASİT VE ÇALIŞAN TASARIM -->
            <div class="payment-simple">
                <div class="payment-simple-header">
                    <h6><i class="fas fa-credit-card me-2"></i>Ödeme Yöntemi</h6>
                    <div class="payment-methods">
                        <button class="btn btn-success btn-payment active" data-payment="nakit">
                            <i class="fas fa-money-bill-wave"></i><br>Nakit
                        </button>
                        <button class="btn btn-primary btn-payment" data-payment="kart">
                            <i class="fas fa-credit-card"></i><br>Kredi Kartı
                        </button>
                        <button class="btn btn-info btn-payment" data-payment="havale">
                            <i class="fas fa-university"></i><br>Havale
                        </button>
                        <button class="btn btn-warning btn-payment" data-payment="karma">
                            <i class="fas fa-exchange-alt"></i><br>Karma Ödeme
                        </button>
                        <button class="btn btn-secondary btn-payment" data-payment="acik_hesap">
                            <i class="fas fa-file-invoice"></i><br>Açık Hesap
                        </button>
                    </div>
                </div>

                <div class="payment-simple-content">
                    <!-- Kredi Kartı Taksit Seçimi -->
                    <div id="kartTaksitSecimi" style="display: none;" class="payment-detail-section">
                        <h6><i class="fas fa-credit-card me-2"></i>Kredi Kartı Detayları</h6>
                        <div class="mb-3">
                            <label class="form-label">Taksit Sayısı <span class="text-danger">*</span></label>
                            <select id="taksitSayisi" class="form-select" required>
                                <option value="">Taksit sayısını seçin</option>
                                <option value="1">Tek Çekim</option>
                                <option value="2">2 Taksit</option>
                                <option value="3">3 Taksit</option>
                                <option value="4">4 Taksit</option>
                                <option value="5">5 Taksit</option>
                                <option value="6">6 Taksit</option>
                                <option value="7">7 Taksit</option>
                                <option value="8">8 Taksit</option>
                                <option value="9">9 Taksit</option>
                            </select>
                        </div>
                    </div>

                    <!-- Karma Ödeme Detayları -->
                    <div id="karmaOdemeDetay" style="display: none;" class="payment-detail-section karma-section">
                        <h6><i class="fas fa-calculator me-2"></i>Karma Ödeme Detayları</h6>
                        
                        <div class="karma-summary mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span><strong>Ödenecek Tutar:</strong></span>
                                <span id="odenecekTutar" class="badge bg-danger fs-6">₺0,00</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span><strong>Ödenen Tutar:</strong></span>
                                <span id="odenenTutar" class="badge bg-success fs-6">₺0,00</span>
                            </div>
                        </div>

                        <div class="karma-payments">
                            <!-- Nakit Ödeme -->
                            <div class="payment-input-group mb-3">
                                <label class="form-label">Nakit</label>
                                <div class="input-group">
                                    <span class="input-group-text">₺</span>
                                    <input type="number" id="nakitTutar" class="form-control" placeholder="0,00" step="0.01" min="0">
                                    <button class="btn btn-outline-secondary" type="button" onclick="nakitTutarTamam()">Tamam</button>
                                </div>
                            </div>

                            <!-- Kart Ödeme -->
                            <div class="payment-input-group mb-3">
                                <label class="form-label">Kredi Kartı</label>
                                <div class="input-group">
                                    <span class="input-group-text">₺</span>
                                    <input type="number" id="kartTutar" class="form-control" placeholder="0,00" step="0.01" min="0">
                                    <select id="kartTaksitKarma" class="form-select" style="max-width: 120px;">
                                        <option value="1">Tek Çekim</option>
                                        <option value="2">2 Taksit</option>
                                        <option value="3">3 Taksit</option>
                                        <option value="4">4 Taksit</option>
                                        <option value="5">5 Taksit</option>
                                        <option value="6">6 Taksit</option>
                                        <option value="7">7 Taksit</option>
                                        <option value="8">8 Taksit</option>
                                        <option value="9">9 Taksit</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="kartTutarTamam()">Tamam</button>
                                </div>
                            </div>

                            <!-- Havale Ödeme -->
                            <div class="payment-input-group mb-3">
                                <label class="form-label">Havale</label>
                                <div class="input-group">
                                    <span class="input-group-text">₺</span>
                                    <input type="number" id="havaleTutar" class="form-control" placeholder="0,00" step="0.01" min="0">
                                    <button class="btn btn-outline-secondary" type="button" onclick="havaleTutarTamam()">Tamam</button>
                                </div>
                            </div>

                            <!-- Hediye Çeki -->
                            <div class="payment-input-group mb-3">
                                <label class="form-label">Hediye Çeki</label>
                                <div class="input-group">
                                    <span class="input-group-text">₺</span>
                                    <input type="number" id="hediyeCekiTutar" class="form-control" placeholder="0,00" readonly>
                                    <button class="btn btn-outline-warning" type="button" id="hediyeCekiKarmaBtn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Ödeme Özeti -->
                        <div id="odemeOzeti" class="karma-ozet">
                            <div id="nakitOzet" class="d-flex justify-content-between" style="display: none !important;">
                                <span>Nakit:</span><span id="nakitOzetTutar">₺0,00</span>
                            </div>
                            <div id="kartOzet" class="d-flex justify-content-between" style="display: none !important;">
                                <span>Kredi Kartı:</span><span id="kartOzetTutar">₺0,00</span>
                            </div>
                            <div id="havaleOzet" class="d-flex justify-content-between" style="display: none !important;">
                                <span>Havale:</span><span id="havaleOzetTutar">₺0,00</span>
                            </div>
                            <div id="hediyeCekiOzet" class="d-flex justify-content-between" style="display: none !important;">
                                <span>Hediye Çeki:</span><span id="hediyeCekiOzetTutar">₺0,00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Tekli Hediye Çeki -->
                    <div id="tekliHediyeCeki" class="payment-detail-section">
                        <label class="form-label">
                            <i class="fas fa-gift"></i> Hediye Çeki
                        </label>
                        <button class="btn btn-outline-warning w-100" id="hediyeCekiBtn">
                            <i class="fas fa-search"></i> Hediye Çeki Sorgula
                        </button>
                    </div>

                    <!-- Açıklama Alanı -->
                    <div class="payment-detail-section">
                        <label class="form-label">
                            <i class="fas fa-comment"></i> Açıklama/Not
                        </label>
                        <textarea id="aciklamaAlani" class="form-control" rows="3" 
                                  placeholder="Bu satış için not veya açıklama yazın..."></textarea>
                        <small class="form-text text-muted">Bu alan isteğe bağlıdır.</small>
                    </div>
                </div>

                <!-- Günlük Satış Özeti -->
                <div class="daily-summary">
                    <h6><i class="fas fa-chart-line me-2"></i>Bugünkü Ödemeler</h6>
                    {% for odeme in bugunun_odeme_toplami %}
                    <div class="d-flex justify-content-between small">
                        <span>{{ odeme.odeme_tipi|title }}:</span>
                        <span>₺{{ odeme.toplam_tutar|floatformat:2 }} ({{ odeme.toplam_adet }})</span>
                    </div>
                    {% empty %}
                    <p class="text-muted small mb-0">Henüz ödeme yok</p>
                    {% endfor %}
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hediye Çeki Modal -->
<div class="modal fade" id="hediyeCekiModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Hediye Çeki Sorgula</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Hediye Çeki Kodu</label>
                    <input type="text" id="hediyeCekiKodu" class="form-control" placeholder="HC000001">
                </div>
                <div id="hediyeCekiBilgi"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="hediyeCekiSorgulaBtn">Sorgula</button>
                <button type="button" class="btn btn-success" id="hediyeCekiKullanaBtn" style="display:none;">Kullan</button>
            </div>
        </div>
    </div>
</div>

<!-- Genel İndirim Modal -->
<div class="modal fade" id="genelIndirimModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Genel İndirim</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">İndirim Türü</label>
                    <select id="indirimTuru" class="form-select">
                        <option value="tutar">Tutar (₺)</option>
                        <option value="yuzde">Yüzde (%)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">İndirim Miktarı</label>
                    <input type="number" id="indirimMiktari" class="form-control" step="0.01" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-success" id="indirimUygulaBtn">Uygula</button>
            </div>
        </div>
    </div>
</div>

<!-- Ürün İndirim Modal -->
<div class="modal fade" id="urunIndirimModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ürün İndirimi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Ürün</label>
                    <div id="secilenUrunBilgi" class="form-control-plaintext"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label">İndirim Türü</label>
                    <select id="urunIndirimTuru" class="form-select">
                        <option value="tutar">Tutar (₺)</option>
                        <option value="yuzde">Yüzde (%)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">İndirim Miktarı</label>
                    <input type="number" id="urunIndirimMiktari" class="form-control" step="0.01" min="0">
                </div>
                <div id="urunIndirimOnizleme" class="alert alert-info" style="display: none;">
                    <small>
                        <strong>Önizleme:</strong><br>
                        Normal Fiyat: <span id="normalFiyat"></span><br>
                        İndirim: <span id="indirimTutari"></span><br>
                        Yeni Fiyat: <span id="yeniFiyat"></span>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-success" id="urunIndirimUygulaBtn">Uygula</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ZXing-js Kütüphanesi - Android uyumlu versiyon -->
<script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>

<script>
// Global değişkenler
let sepet = [];
let seciliMusteri = null;
let seciliOdemeYontemi = 'nakit';
let genelIndirim = 0;
let kullanilacakHediyeCeki = null;
let karmaOdeme = {
    nakit: 0,
    kart: 0,
    havale: 0,
    hediye_ceki: 0
};

// Kamera değişkenleri
let satisScanning = false;
let codeReader = null;
let selectedDeviceId = null;
let cameraDevices = [];
let scanStream = null;

// Sayfa yüklendiğinde
$(document).ready(function() {
    sepetGuncelle();
    
    // Müşteri bilgisini al
    const musteriId = $('#musteriId').val();
    if (musteriId) {
        seciliMusteri = { id: musteriId };
        // Müşteri seçiliyse input'tan kırmızı stili kaldır
        $('#musteriAramaInput').removeClass('required-field');
    } else {
        // Müşteri seçilmemişse input'u kırmızı yap
        $('#musteriAramaInput').addClass('required-field');
    }
    
    // Event listener'ları ekle
    setupEventListeners();
});

function setupEventListeners() {
    // Barkod input
    $('#barkodInput').on('keypress', function(e) {
        if (e.which === 13) { // Enter tuşu
            const barkod = $(this).val().trim();
            if (barkod) {
                barkodSorgula(barkod);
                $(this).val('');
            }
        }
    });

    // Ürün arama
    $('#urunAramaInput').on('input', function() {
        const query = $(this).val().trim();
        if (query.length >= 2) {
            urunAra(query);
        } else {
            $('#aramaContainer').hide();
        }
    });

    // Müşteri arama
    $('#musteriAramaInput').on('input', function() {
        const query = $(this).val().trim();
        if (query.length >= 2) {
            musteriAra(query);
        } else {
            $('#musteriAramaContainer').hide();
            // Input temizlendiyse müşteri seçimini kaldır
            if (query.length === 0) {
                seciliMusteri = null;
                $('#secilenMusteri').html('<em>Müşteri seçili değil</em>');
                $('#musteriId').val('');
                $(this).addClass('required-field');
                satisTamamlaButonKontrol();
            }
        }
    });

    // Ödeme yöntemi seçimi
    $('.btn-payment').on('click', function() {
        // Tüm butonlardan active sınıfını kaldır
        $('.btn-payment').removeClass('active');
        
        // Seçilen butona active sınıfını ekle
        $(this).addClass('active');
        
        // Seçilen ödeme yöntemini kaydet
        seciliOdemeYontemi = $(this).data('payment');
        
        // Görsel geri bildirim için kısa titreşim efekti
        $(this).css('animation', 'pulse 0.3s ease-in-out');
        setTimeout(() => {
            $(this).css('animation', '');
        }, 300);
        
        // Seçim bilgisini göster
        const odemeAdi = $(this).text().trim();
        showAlert('info', `${odemeAdi} ödeme yöntemi seçildi`, 1500);
        
        // Kredi kartı taksit seçimi göster/gizle
        if (seciliOdemeYontemi === 'kart') {
            $('#kartTaksitSecimi').show();
            $('#karmaOdemeDetay').hide();
            $('#tekliHediyeCeki').show();
            $('.payment-section-new').removeClass('karma-active');
        } else if (seciliOdemeYontemi === 'karma') {
            $('#karmaOdemeDetay').show();
            $('#kartTaksitSecimi').hide();
            $('#tekliHediyeCeki').hide();
            $('.payment-section-new').addClass('karma-active');
            
            // Karma ödeme açılırken animasyon
            setTimeout(() => {
                karmaOdemeGuncelle();
            }, 100);
            
        } else {
            $('#karmaOdemeDetay').hide();
            $('#kartTaksitSecimi').hide();
            $('#tekliHediyeCeki').show();
            $('.payment-section-new').removeClass('karma-active');
            
            // Karma ödeme değilse temizle
            karmaOdeme = { nakit: 0, kart: 0, havale: 0, hediye_ceki: 0 };
            kullanilacakHediyeCeki = null;
        }
        
        // Açık hesap için müşteri kontrolü
        if (seciliOdemeYontemi === 'acik_hesap' && !seciliMusteri) {
            showAlert('warning', 'Açık hesap satışı için müşteri seçmelisiniz!');
            // Nakit'e geri dön
            $('.btn-payment[data-payment="nakit"]').click();
        }
        
        satisTamamlaButonKontrol();
    });

    // Taksit sayısı değişikliği
    $('#taksitSayisi').on('change', function() {
        satisTamamlaButonKontrol();
    });

    // Sepet temizle
    $('#sepetTemizleBtn').on('click', function() {
        if (confirm('Sepeti temizlemek istediğinizden emin misiniz?')) {
            sepetTemizle();
        }
    });

    // Satış tamamla
    $('#satisTamamlaBtn').on('click', function() {
        satisTamamla();
    });

    // Genel indirim
    $('#genelIndirimuygula').on('click', function() {
        $('#genelIndirimModal').modal('show');
    });

    $('#indirimUygulaBtn').on('click', function() {
        uygulaGenelIndirim();
    });

    // Hediye çeki
    $('#hediyeCekiBtn').on('click', function() {
        $('#hediyeCekiModal').modal('show');
    });

    $('#hediyeCekiKarmaBtn').on('click', function() {
        $('#hediyeCekiModal').modal('show');
    });

    $('#hediyeCekiSorgulaBtn').on('click', function() {
        hediyeCekiSorgula();
    });

    $('#hediyeCekiKullanaBtn').on('click', function() {
        hediyeCekiKullan();
    });

    // Doküman click - arama sonuçlarını gizle
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#urunAramaInput, #aramaContainer').length) {
            $('#aramaContainer').hide();
        }
        if (!$(e.target).closest('#musteriAramaInput, #musteriAramaContainer').length) {
            $('#musteriAramaContainer').hide();
        }
    });
}

// Barkod sorgulama
function barkodSorgula(barkod) {
    $.get('/satis/barkod-sorgula/', { barkod: barkod })
        .done(function(data) {
            if (data.success) {
                sepeteEkle(data.urun);
            } else {
                showAlert('danger', data.message);
            }
        })
        .fail(function() {
            showAlert('danger', 'Barkod sorgulanırken hata oluştu');
        });
}

// Ürün arama
function urunAra(query) {
    $.get('/satis/ajax/urun-ara/', { q: query })
        .done(function(data) {
            if (data.success && data.urunler.length > 0) {
                let html = '';
                data.urunler.forEach(function(urun) {
                    html += `
                        <div class="search-item" onclick="sepeteEkle(${JSON.stringify(urun).replace(/"/g, '&quot;')})">
                            <strong>${urun.ad}</strong><br>
                            <small class="text-muted">
                                Barkod: ${urun.barkod} | 
                                ${urun.beden ? `Beden: ${urun.beden} | ` : ''}
                                Fiyat: ₺${urun.satis_fiyati} | Stok: ${urun.stok_miktari}
                            </small>
                        </div>
                    `;
                });
                $('#aramaContainer').html(html).show();
            } else {
                $('#aramaContainer').html('<div class="search-item">Ürün bulunamadı</div>').show();
            }
        });
}

// Müşteri arama
function musteriAra(query) {
    $.get('/satis/ajax/musteri-ara/', { q: query })
        .done(function(data) {
            if (data.success && data.musteriler.length > 0) {
                let html = '';
                data.musteriler.forEach(function(musteri) {
                    html += `
                        <div class="search-item" onclick="musteriSec(${JSON.stringify(musteri).replace(/"/g, '&quot;')})">
                            <strong>${musteri.ad} ${musteri.soyad}</strong><br>
                            <small class="text-muted">
                                ${musteri.telefon} ${musteri.firma_adi ? '| ' + musteri.firma_adi : ''}
                            </small>
                        </div>
                    `;
                });
                $('#musteriAramaContainer').html(html).show();
            } else {
                $('#musteriAramaContainer').html('<div class="search-item">Müşteri bulunamadı</div>').show();
            }
        });
}

// Karma ödeme fonksiyonları
function karmaOdemeGuncelle() {
    const genelToplam = hesaplaGenelToplam();
    const toplamOdenen = karmaOdeme.nakit + karmaOdeme.kart + karmaOdeme.havale + karmaOdeme.hediye_ceki;
    const kalanTutar = Math.max(0, genelToplam - toplamOdenen);
    
    $('#odenecekTutar').text('₺' + kalanTutar.toFixed(2));
    $('#odenenTutar').text('₺' + toplamOdenen.toFixed(2));
    
    // Özet güncelle
    updateOdemeOzeti();
    
    // Satış tamamlama butonu kontrolü
    satisTamamlaButonKontrol();
}

function updateOdemeOzeti() {
    // Nakit özeti
    if (karmaOdeme.nakit > 0) {
        $('#nakitOzet').show();
        $('#nakitOzetTutar').text('₺' + karmaOdeme.nakit.toFixed(2));
    } else {
        $('#nakitOzet').hide();
    }
    
    // Kart özeti
    if (karmaOdeme.kart > 0) {
        $('#kartOzet').show();
        $('#kartOzetTutar').text('₺' + karmaOdeme.kart.toFixed(2));
    } else {
        $('#kartOzet').hide();
    }
    
    // Havale özeti
    if (karmaOdeme.havale > 0) {
        $('#havaleOzet').show();
        $('#havaleOzetTutar').text('₺' + karmaOdeme.havale.toFixed(2));
    } else {
        $('#havaleOzet').hide();
    }
    
    // Hediye çeki özeti
    if (karmaOdeme.hediye_ceki > 0) {
        $('#hediyeCekiOzet').show();
        $('#hediyeCekiOzetTutar').text('₺' + karmaOdeme.hediye_ceki.toFixed(2));
    } else {
        $('#hediyeCekiOzet').hide();
    }
}

function nakitTutarTamam() {
    const tutar = parseFloat($('#nakitTutar').val()) || 0;
    const genelToplam = hesaplaGenelToplam();
    const digerOdemeler = karmaOdeme.kart + karmaOdeme.havale + karmaOdeme.hediye_ceki;
    const maxNakit = Math.max(0, genelToplam - digerOdemeler);
    
    if (tutar > maxNakit) {
        showAlert('warning', `Maksimum nakit tutarı: ₺${maxNakit.toFixed(2)}`);
        $('#nakitTutar').val(maxNakit.toFixed(2));
        karmaOdeme.nakit = maxNakit;
    } else {
        karmaOdeme.nakit = tutar;
    }
    
    karmaOdemeGuncelle();
}

function kartTutarTamam() {
    const tutar = parseFloat($('#kartTutar').val()) || 0;
    const genelToplam = hesaplaGenelToplam();
    const digerOdemeler = karmaOdeme.nakit + karmaOdeme.havale + karmaOdeme.hediye_ceki;
    const maxKart = Math.max(0, genelToplam - digerOdemeler);
    
    if (tutar > maxKart) {
        showAlert('warning', `Maksimum kart tutarı: ₺${maxKart.toFixed(2)}`);
        $('#kartTutar').val(maxKart.toFixed(2));
        karmaOdeme.kart = maxKart;
    } else {
        karmaOdeme.kart = tutar;
    }
    
    karmaOdemeGuncelle();
}

function havaleTutarTamam() {
    const tutar = parseFloat($('#havaleTutar').val()) || 0;
    const genelToplam = hesaplaGenelToplam();
    const digerOdemeler = karmaOdeme.nakit + karmaOdeme.kart + karmaOdeme.hediye_ceki;
    const maxHavale = Math.max(0, genelToplam - digerOdemeler);
    
    if (tutar > maxHavale) {
        showAlert('warning', `Maksimum havale tutarı: ₺${maxHavale.toFixed(2)}`);
        $('#havaleTutar').val(maxHavale.toFixed(2));
        karmaOdeme.havale = maxHavale;
    } else {
        karmaOdeme.havale = tutar;
    }
    
    karmaOdemeGuncelle();
}

function satisTamamlaButonKontrol() {
    const sepetBos = sepet.length === 0;
    const musteriYok = !seciliMusteri; // Müşteri zorunlu kontrol
    let odemeTamam = false;
    
    if (seciliOdemeYontemi === 'karma') {
        const genelToplam = hesaplaGenelToplam();
        const toplamOdenen = karmaOdeme.nakit + karmaOdeme.kart + karmaOdeme.havale + karmaOdeme.hediye_ceki;
        odemeTamam = Math.abs(genelToplam - toplamOdenen) < 0.01; // Küsurat farklarını tolere et
    } else if (seciliOdemeYontemi === 'acik_hesap') {
        odemeTamam = seciliMusteri !== null;
    } else if (seciliOdemeYontemi === 'kart') {
        // Kredi kartı için taksit sayısı zorunlu
        const taksitSayisi = $('#taksitSayisi').val();
        odemeTamam = taksitSayisi && taksitSayisi !== '';
    } else {
        odemeTamam = true; // Diğer ödeme yöntemleri için her zaman true
    }
    
    // Test için geçici - daha sonra kaldırılacak
    $('#satisTamamlaBtn').prop('disabled', false);
}

function hesaplaGenelToplam() {
    let araToplam = sepet.reduce((sum, item) => sum + item.toplam, 0);
    araToplam -= genelIndirim;
    return araToplam; // KDV hesaplaması kaldırıldı, fiyatlar zaten KDV dahil
}
function musteriSec(musteri) {
    seciliMusteri = musteri;
    $('#musteriAramaInput').val(`${musteri.ad} ${musteri.soyad}`);
    $('#secilenMusteri').html(`
        <strong>${musteri.ad} ${musteri.soyad}</strong><br>
        <small>${musteri.telefon}</small>
    `);
    $('#musteriId').val(musteri.id);
    $('#musteriAramaContainer').hide();
    
    // Zorunlu alan stilini kaldır
    $('#musteriAramaInput').removeClass('required-field');
    
    // Açık hesap kontrolü
    satisTamamlaButonKontrol();
}

// Sepete ekleme
function sepeteEkle(urun) {
    const mevcutUrun = sepet.find(item => item.id === urun.id && item.varyant_id === urun.varyant_id);
    
    if (mevcutUrun) {
        mevcutUrun.miktar += 1;
        mevcutUrun.toplam = (mevcutUrun.fiyat * mevcutUrun.miktar) - mevcutUrun.indirim;
    } else {
        sepet.push({
            id: urun.id,
            varyant_id: urun.varyant_id,
            ad: urun.ad,
            barkod: urun.barkod,
            beden: urun.beden,
            renk: urun.renk,
            fiyat: parseFloat(urun.satis_fiyati),
            miktar: 1,
            toplam: parseFloat(urun.satis_fiyati),
            stok: urun.stok_miktari,
            indirim: 0
        });
    }
    
    sepetGuncelle();
    $('#aramaContainer').hide();
    $('#urunAramaInput').val('');
    showAlert('success', `${urun.ad} ${urun.beden ? '(' + urun.beden + ')' : ''} sepete eklendi`);
}

// Sepetten çıkarma
function sepettenCikar(urunId) {
    sepet = sepet.filter(item => item.id !== urunId);
    sepetGuncelle();
    showAlert('info', 'Ürün sepetten çıkarıldı');
}

// Miktar güncelleme
function miktarGuncelle(urunId, yeniMiktar) {
    const urun = sepet.find(item => item.id === urunId);
    if (urun && yeniMiktar > 0 && yeniMiktar <= urun.stok) {
        urun.miktar = yeniMiktar;
        urun.toplam = (urun.fiyat * urun.miktar) - urun.indirim;
        sepetGuncelle();
    }
}

// Sepet güncelleme
function sepetGuncelle() {
    const container = $('#sepetContainer');
    
    if (sepet.length === 0) {
        container.html(`
            <div class="empty-cart">
                <i class="fas fa-shopping-cart"></i>
                <p>Sepet boş. Ürün eklemek için barkod okutun veya ürün arayın.</p>
            </div>
        `);
        $('#satisTamamlaBtn').prop('disabled', true);
    } else {
        let html = '';
        sepet.forEach(function(item) {
            html += `
                <div class="cart-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                            <strong>${item.ad}</strong><br>
                            <small class="text-muted">
                                Barkod: ${item.barkod} | 
                                ${item.beden ? `Beden: ${item.beden} | ` : ''}
                                Birim: ₺${item.fiyat.toFixed(2)}
                            </small>
                        </div>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="miktarGuncelle(${item.id}, ${item.miktar - 1})">-</button>
                            <input type="number" class="quantity-input" value="${item.miktar}" 
                                   onchange="miktarGuncelle(${item.id}, parseInt(this.value))" min="1" max="${item.stok}">
                            <button class="quantity-btn" onclick="miktarGuncelle(${item.id}, ${item.miktar + 1})">+</button>
                        </div>
                        <div class="text-end ms-2">
                            <div><strong>₺${item.toplam.toFixed(2)}</strong></div>
                            ${item.indirim > 0 ? `<small class="text-success">İndirim: ₺${item.indirim.toFixed(2)}</small>` : ''}
                            <div>
                                <button class="btn btn-sm btn-outline-warning me-1" onclick="urunIndirimiAc(${item.id})" title="İndirim Uygula">
                                    <i class="fas fa-percent"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="sepettenCikar(${item.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.html(html);
        satisTamamlaButonKontrol();
    }
    
    // Toplam hesaplama
    hesaplaToplamlar();
    
    // Karma ödeme güncelle
    if (seciliOdemeYontemi === 'karma') {
        karmaOdemeGuncelle();
    }
}

// Toplam hesaplama
function hesaplaToplamlar() {
    let toplamUrun = sepet.length;
    let toplamMiktar = sepet.reduce((sum, item) => sum + item.miktar, 0);
    
    // Ham ara toplam (indirimsiz)
    let hamAraToplam = sepet.reduce((sum, item) => sum + (item.fiyat * item.miktar), 0);
    
    // Ürün bazlı toplam indirim
    let toplamUrunIndirimi = sepet.reduce((sum, item) => sum + (item.indirim || 0), 0);
    
    // İndirimli ara toplam
    let araToplam = hamAraToplam - toplamUrunIndirimi;
    
    // Genel indirim uygula
    const indirimliToplam = araToplam - genelIndirim;
    
    let genelToplam = indirimliToplam; // KDV hesaplaması kaldırıldı
    
    // Tekli ödeme modunda hediye çeki indirimi (karma ödemede ayrı hesaplanıyor)
    if (kullanilacakHediyeCeki && seciliOdemeYontemi !== 'karma') {
        genelToplam -= kullanilacakHediyeCeki.kullanilacak_tutar || kullanilacakHediyeCeki.bakiye || kullanilacakHediyeCeki.kalan_tutar;
    }
    
    // Ara toplam ve genel toplam ekranda göster
    $('#toplamUrun').text(toplamUrun);
    $('#toplamMiktar').text(toplamMiktar);
    $('#araToplam').text(`₺${hamAraToplam.toFixed(2)}`);
    $('#genelToplam').text(`₺${Math.max(0, genelToplam).toFixed(2)}`);
    
    // Ürün indirimleri satırını göster/gizle
    if (toplamUrunIndirimi > 0) {
        $('#urunIndirimSatiri').show();
        $('#urunIndirimTutari').text(`-₺${toplamUrunIndirimi.toFixed(2)}`);
    } else {
        $('#urunIndirimSatiri').hide();
    }
    
    // Genel indirim satırını göster/gizle
    if (genelIndirim > 0) {
        $('#genelIndirimSatiri').show();
        $('#genelIndirimTutari').text(`-₺${genelIndirim.toFixed(2)}`);
    } else {
        $('#genelIndirimSatiri').hide();
    }
}

// Sepet temizle
function sepetTemizle() {
    sepet = [];
    genelIndirim = 0;
    kullanilacakHediyeCeki = null;
    karmaOdeme = { nakit: 0, kart: 0, havale: 0, hediye_ceki: 0 };
    
    // Input'ları temizle
    $('#nakitTutar').val('');
    $('#kartTutar').val('');
    $('#havaleTutar').val('');
    $('#hediyeCekiTutar').val('');
    $('#taksitSayisi').val('');
    $('#aciklamaAlani').val(''); // Açıklama alanını temizle
    
    sepetGuncelle();
}

// Genel indirim uygulama
function uygulaGenelIndirim() {
    const indirimTuru = $('#indirimTuru').val();
    const indirimMiktari = parseFloat($('#indirimMiktari').val()) || 0;
    const araToplam = sepet.reduce((sum, item) => sum + item.toplam, 0);
    
    if (indirimTuru === 'yuzde') {
        genelIndirim = araToplam * (indirimMiktari / 100);
    } else {
        genelIndirim = indirimMiktari;
    }
    
    sepetGuncelle();
    $('#genelIndirimModal').modal('hide');
    showAlert('success', 'Genel indirim uygulandı');
}

// Hediye çeki sorgulama
function hediyeCekiSorgula() {
    const kod = $('#hediyeCekiKodu').val().trim();
    if (!kod) {
        showAlert('warning', 'Hediye çeki kodu giriniz');
        return;
    }
    
    $.get('/satis/hediye-ceki-sorgula/', { kod: kod })
        .done(function(data) {
            if (data.success) {
                $('#hediyeCekiBilgi').html(`
                    <div class="alert alert-success">
                        <strong>Hediye Çeki Bulundu!</strong><br>
                        Kod: ${data.hediye_ceki.kod}<br>
                        Bakiye: ₺${data.hediye_ceki.kalan_tutar}<br>
                        Durum: ${data.hediye_ceki.durum}
                    </div>
                `);
                $('#hediyeCekiKullanaBtn').show().data('hediye-ceki', data.hediye_ceki);
            } else {
                $('#hediyeCekiBilgi').html(`
                    <div class="alert alert-danger">
                        ${data.message}
                    </div>
                `);
                $('#hediyeCekiKullanaBtn').hide();
            }
        });
}

function hediyeCekiKullan() {
    const hediyeCeki = $('#hediyeCekiKullanaBtn').data('hediye-ceki');
    
    if (seciliOdemeYontemi === 'karma') {
        // Karma ödemede hediye çeki tutarını ekle
        const genelToplam = hesaplaGenelToplam();
        const digerOdemeler = karmaOdeme.nakit + karmaOdeme.kart + karmaOdeme.havale;
        const maxHediyeCeki = Math.min(parseFloat(hediyeCeki.kalan_tutar), genelToplam - digerOdemeler);
        
        karmaOdeme.hediye_ceki = maxHediyeCeki;
        $('#hediyeCekiTutar').val(maxHediyeCeki.toFixed(2));
        
        kullanilacakHediyeCeki = {
            ...hediyeCeki,
            kullanilacak_tutar: maxHediyeCeki
        };
        
        karmaOdemeGuncelle();
        showAlert('success', `Hediye çeki karma ödemeye eklendi: ₺${maxHediyeCeki.toFixed(2)}`);
    } else {
        // Tekli ödemede tüm tutarı kullan
        kullanilacakHediyeCeki = {
            ...hediyeCeki,
            kullanilacak_tutar: parseFloat(hediyeCeki.kalan_tutar)
        };
        
        showAlert('success', `Hediye çeki eklendi: ₺${hediyeCeki.kalan_tutar}`);
        hesaplaToplamlar();
    }
    
    $('#hediyeCekiModal').modal('hide');
}

// Satış tamamlama
function satisTamamla() {
    if (sepet.length === 0) {
        showAlert('warning', 'Sepet boş!');
        return;
    }
    
    // Müşteri seçimi kontrolü
    if (!seciliMusteri) {
        showAlert('error', 'Satış için müşteri seçmek zorunludur!');
        $('#musteriAramaInput').focus();
        return;
    }
    
    // Ödeme detaylarını hazırla
    let odemeDetaylari = {
        tip: seciliOdemeYontemi === 'karma' ? 'karma' : 'tek',
        odeme_yontemi: seciliOdemeYontemi
    };
    
    // Taksit sayısı ekle (kredi kartı için)
    if (seciliOdemeYontemi === 'kart') {
        odemeDetaylari.taksit_sayisi = parseInt($('#taksitSayisi').val()) || 1;
    }
    
    // Karma ödeme detayları
    if (seciliOdemeYontemi === 'karma') {
        odemeDetaylari.karma_detay = {
            nakit: karmaOdeme.nakit,
            kart: karmaOdeme.kart,
            havale: karmaOdeme.havale,
            hediye_ceki: karmaOdeme.hediye_ceki
        };
    }
    
    const data = {
        sepet: sepet.map(item => ({
            ...item,
            urun_indirim: item.indirim // Ürün bazlı indirim
        })),
        musteri_id: seciliMusteri ? seciliMusteri.id : null,
        odeme_detaylari: odemeDetaylari,
        genel_indirim: genelIndirim,
        hediye_ceki: kullanilacakHediyeCeki,
        aciklama: $('#aciklamaAlani').val().trim() // Açıklama/Not eklendi
    };
    
    $.ajax({
        url: '/satis/tamamla/',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        beforeSend: function() {
            $('#satisTamamlaBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> İşleniyor...');
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', 'Satış başarıyla tamamlandı!');
                
                // Yazdırma seçeneği
                if (confirm('Fiş yazdırılsın mı?')) {
                    window.open(`/satis/${response.satis_id}/yazdır/`, '_blank');
                }
                
                // Sepeti temizle
                sepetTemizle();
                
                // Yeni sipariş numarası al
                yeniSiparisNumarasi();
                
            } else {
                showAlert('danger', response.message);
            }
        },
        error: function() {
            showAlert('danger', 'Satış tamamlanırken hata oluştu');
        },
        complete: function() {
            $('#satisTamamlaBtn').prop('disabled', false).html('<i class="fas fa-check"></i> Satışı Tamamla');
        }
    });
}

// Yeni sipariş numarası
function yeniSiparisNumarasi() {
    $.get('/satis/ajax/yeni-siparis-no/')
        .done(function(data) {
            if (data.success) {
                $('.barcode-section .float-end').text('Sipariş No: ' + data.siparis_no);
            }
        });
}

// Alert gösterme
function showAlert(type, message, timeout = 5000) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    // Belirtilen süre sonra otomatik kapat
    setTimeout(function() {
        $('.alert').fadeOut(function() {
            $(this).remove();
        });
    }, timeout);
}

// Ürün indirim fonksiyonları
let seciliIndirimUrunId = null;

function urunIndirimiAc(urunId) {
    const urun = sepet.find(item => item.id === urunId);
    if (!urun) return;
    
    seciliIndirimUrunId = urunId;
    
    // Modal bilgilerini doldur
    $('#secilenUrunBilgi').html(`
        <strong>${urun.ad}</strong><br>
        <small>Barkod: ${urun.barkod} | Miktar: ${urun.miktar} | Birim Fiyat: ₺${urun.fiyat.toFixed(2)}</small>
    `);
    
    // Mevcut indirim varsa göster
    if (urun.indirim > 0) {
        $('#urunIndirimMiktari').val(urun.indirim.toFixed(2));
        $('#urunIndirimTuru').val('tutar');
    } else {
        $('#urunIndirimMiktari').val('');
        $('#urunIndirimTuru').val('tutar');
    }
    
    // Önizleme güncelle
    urunIndirimOnizleme();
    
    $('#urunIndirimModal').modal('show');
}

function urunIndirimOnizleme() {
    const urun = sepet.find(item => item.id === seciliIndirimUrunId);
    if (!urun) return;
    
    const indirimTuru = $('#urunIndirimTuru').val();
    const indirimMiktari = parseFloat($('#urunIndirimMiktari').val()) || 0;
    
    let indirimTutari = 0;
    const normalToplam = urun.fiyat * urun.miktar;
    
    if (indirimTuru === 'tutar') {
        indirimTutari = Math.min(indirimMiktari, normalToplam);
    } else if (indirimTuru === 'yuzde') {
        indirimTutari = (normalToplam * indirimMiktari) / 100;
        indirimTutari = Math.min(indirimTutari, normalToplam);
    }
    
    const yeniToplam = normalToplam - indirimTutari;
    
    $('#normalFiyat').text(`₺${normalToplam.toFixed(2)}`);
    $('#indirimTutari').text(`₺${indirimTutari.toFixed(2)}`);
    $('#yeniFiyat').text(`₺${yeniToplam.toFixed(2)}`);
    
    $('#urunIndirimOnizleme').show();
}

function urunIndirimUygula() {
    const urun = sepet.find(item => item.id === seciliIndirimUrunId);
    if (!urun) return;
    
    const indirimTuru = $('#urunIndirimTuru').val();
    const indirimMiktari = parseFloat($('#urunIndirimMiktari').val()) || 0;
    
    let indirimTutari = 0;
    const normalToplam = urun.fiyat * urun.miktar;
    
    if (indirimTuru === 'tutar') {
        indirimTutari = Math.min(indirimMiktari, normalToplam);
    } else if (indirimTuru === 'yuzde') {
        indirimTutari = (normalToplam * indirimMiktari) / 100;
        indirimTutari = Math.min(indirimTutari, normalToplam);
    }
    
    // İndirim uygula
    urun.indirim = indirimTutari;
    urun.toplam = normalToplam - indirimTutari;
    
    // Sepeti güncelle
    sepetGuncelle();
    
    // Modal kapat
    $('#urunIndirimModal').modal('hide');
    
    // Bilgi mesajı
    showAlert('success', `${urun.ad} ürününe ₺${indirimTutari.toFixed(2)} indirim uygulandı`);
}

// Event listener'ları ekle
$(document).ready(function() {
    // Ürün indirim modal event listener'ları
    $('#urunIndirimTuru, #urunIndirimMiktari').on('change input', urunIndirimOnizleme);
    $('#urunIndirimUygulaBtn').on('click', urunIndirimUygula);
    
    $('#indirimUygulaBtn').on('click', function() {
        const indirimTuru = $('#indirimTuru').val();
        const indirimMiktari = parseFloat($('#indirimMiktari').val()) || 0;
        
        if (indirimMiktari <= 0) {
            showAlert('warning', 'Geçerli bir indirim miktarı girin');
            return;
        }
        
        const araToplam = sepet.reduce((sum, item) => sum + item.toplam, 0);
        
        if (indirimTuru === 'tutar') {
            genelIndirim = Math.min(indirimMiktari, araToplam);
        } else if (indirimTuru === 'yuzde') {
            genelIndirim = Math.min((araToplam * indirimMiktari) / 100, araToplam);
        }
        
        hesaplaToplamlar();
        $('#genelIndirimModal').modal('hide');
        showAlert('success', `₺${genelIndirim.toFixed(2)} genel indirim uygulandı`);
    });

    // Satış ekranı kamera kontrolleri
    $('#satisKameraBtn').click(function() {
        if (!satisScanning) {
            startSatisCamera();
        }
    });

    $('#satisStopCamera').click(function() {
        stopSatisCamera();
    });
    
    $('#satisSwitchCamera').click(function() {
        switchCamera();
    });

    async function startSatisCamera() {
        try {
            $('#satisKameraArea').removeClass('d-none');
            $('#satisKameraBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Başlatılıyor...');
            
            // Device detection
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isMobile = isIOS || isAndroid || /webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            console.log('Device detection:', { isIOS, isAndroid, isMobile });
            
            // ZXing kütüphanesini başlat
            codeReader = new ZXing.BrowserMultiFormatReader();
            
            // iOS ve Android için farklı kamera listesi alma stratejileri
            let videoInputDevices = [];
            try {
                if (isIOS) {
                    // iOS için özel handling
                    console.log('iOS cihaz algılandı, özel kamera listesi alınıyor...');
                    
                    // iOS Safari için navigator.mediaDevices.enumerateDevices() daha güvenilir
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    videoInputDevices = devices.filter(device => device.kind === 'videoinput');
                    
                    console.log('iOS kameralar:', videoInputDevices);
                    
                } else {
                    // Android ve diğer platformlar için normal API
                    videoInputDevices = await codeReader.listVideoInputDevices();
                }
            } catch (err) {
                console.log('Kamera listesi alma hatası, fallback yöntem:', err);
                // Fallback: navigator.mediaDevices kullan
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    videoInputDevices = devices.filter(device => device.kind === 'videoinput');
                } catch (fallbackErr) {
                    console.log('Fallback da başarısız, varsayılan kamerayı kullan');
                    videoInputDevices = [{ deviceId: 'default', label: 'Varsayılan Kamera' }];
                }
            }
            
            cameraDevices = videoInputDevices;
            
            if (cameraDevices.length === 0) {
                throw new Error('Hiç kamera bulunamadı');
            }
            
            console.log('Bulunan kameralar:', cameraDevices.map(d => ({ id: d.deviceId, label: d.label })));
            
            // iOS ve Android için farklı kamera seçim stratejileri
            if (isIOS) {
                // iOS için arka kamera seçimi (genelde son kamera arka kameradır)
                selectedDeviceId = cameraDevices.find(device => 
                    device.label && (
                        device.label.toLowerCase().includes('back') || 
                        device.label.toLowerCase().includes('rear') ||
                        device.label.toLowerCase().includes('environment') ||
                        device.label.toLowerCase().includes('wide') ||  // iOS'ta genelde "Wide" arka kamera
                        device.label.toLowerCase().includes('main')     // Bazı iOS cihazlarda "Main Camera"
                    )
                )?.deviceId;
                
                // iOS'ta genelde son indeksteki kamera arka kameradır
                if (!selectedDeviceId && cameraDevices.length > 1) {
                    selectedDeviceId = cameraDevices[cameraDevices.length - 1].deviceId;
                } else if (!selectedDeviceId) {
                    selectedDeviceId = cameraDevices[0].deviceId;
                }
                
            } else if (isAndroid) {
                // Android için arka kamera seçimi
                selectedDeviceId = cameraDevices.find(device => 
                    device.label && (
                        device.label.toLowerCase().includes('back') || 
                        device.label.toLowerCase().includes('rear') ||
                        device.label.toLowerCase().includes('environment') ||
                        device.label.toLowerCase().includes('arka')
                    )
                )?.deviceId;
                
                // Arka kamera bulunamazsa son kamerayı kullan
                if (!selectedDeviceId) {
                    selectedDeviceId = cameraDevices[cameraDevices.length - 1].deviceId;
                }
            } else {
                // Masaüstü için ilk kamerayı kullan
                selectedDeviceId = cameraDevices[0].deviceId;
            }
            
            console.log('Seçilen kamera ID:', selectedDeviceId);
            
            // Kamera değiştir butonunu göster (birden fazla kamera varsa)
            if (cameraDevices.length > 1) {
                $('#satisSwitchCamera').show();
            } else {
                $('#satisSwitchCamera').hide();
            }
            
            // iOS ve Android için optimize edilmiş constraints
            const constraints = {
                video: {
                    deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                    // iOS için facingMode environment daha güvenilir
                    facingMode: (isIOS || isAndroid) ? 'environment' : 'user',
                    width: { ideal: isIOS ? 1920 : 1280 },  // iOS daha yüksek çözünürlük destekler
                    height: { ideal: isIOS ? 1080 : 720 },
                    frameRate: { ideal: 30, max: 30 }       // iOS için frame rate sınırı
                }
            };
            
            console.log('Kullanılacak constraints:', constraints);
            
            // Kamerayı başlat - iOS/Android uyumlu yöntem
            try {
                if (isIOS) {
                    // iOS için önce getUserMedia ile test et
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    stream.getTracks().forEach(track => track.stop()); // Test stream'i kapat
                }
                
                await codeReader.decodeFromVideoDevice(selectedDeviceId, 'satisPreview', (result, err) => {
                    if (result) {
                        console.log('Barkod okundu:', result.text);
                        onBarcodeDetected(result.text);
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.log('Okuma hatası:', err);
                    }
                });
                
            } catch (decodeErr) {
                console.log('Decode hatası, iOS/Android fallback yöntemi:', decodeErr);
                
                if (isIOS) {
                    // iOS fallback: basit constraints
                    await codeReader.decodeFromVideoDevice(undefined, 'satisPreview', (result, err) => {
                        if (result) {
                            console.log('Barkod okundu:', result.text);
                            onBarcodeDetected(result.text);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.log('Okuma hatası:', err);
                        }
                    });
                } else {
                    // Android fallback
                    await codeReader.decodeFromVideoDevice(undefined, 'satisPreview', (result, err) => {
                        if (result) {
                            console.log('Barkod okundu:', result.text);
                            onBarcodeDetected(result.text);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.log('Okuma hatası:', err);
                        }
                    });
                }
            }
            
            satisScanning = true;
            $('#satisKameraBtn').html('<i class="fas fa-camera text-warning"></i> Aktif').removeClass('btn-success').addClass('btn-warning');
            
            // iOS için özel uyarı
            if (isIOS) {
                showAlert('info', '📱 iOS cihazında en iyi sonuç için kamerayı barkoda yaklaştırın');
            }
            
            console.log('Kamera başarıyla başlatıldı');
            
        } catch (err) {
            console.error('Kamera başlatma hatası:', err);
            let errorMessage = 'Kamera başlatılamadı';
            
            if (err.name === 'NotAllowedError') {
                if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                    errorMessage = '📱 iOS: Ayarlar → Safari → Kamera erişimine izin verin ve sayfayı yenileyin.';
                } else {
                    errorMessage = 'Kamera izni reddedildi. Lütfen tarayıcı ayarlarınızdan kamera erişimine izin verin.';
                }
            } else if (err.name === 'NotFoundError') {
                errorMessage = 'Kamera bulunamadı. Cihazınızda kamera olduğundan emin olun.';
            } else if (err.name === 'NotSupportedError') {
                errorMessage = 'Tarayıcınız kamera özelliğini desteklemiyor.';
            } else if (err.name === 'NotReadableError') {
                errorMessage = 'Kamera kullanımda. Diğer uygulamaları kapatıp tekrar deneyin.';
            } else if (err.message) {
                errorMessage = err.message;
            }
            
            showAlert('danger', errorMessage);
            stopSatisCamera();
        }
    }

    function onBarcodeDetected(code) {
        if (!satisScanning) return;
        
        console.log("Satış barkod okundu:", code);
        
        // Başarı animasyonu
        $('.barcode-section').addClass('barcode-success');
        setTimeout(() => $('.barcode-section').removeClass('barcode-success'), 500);
        
        // Sonucu göster
        $('#satisScannedCode').text(code);
        $('#satisScanResult').removeClass('d-none');
        
        // Barkod input'una yaz
        $('#barkodInput').val(code);
        
        // Barkod sorgula
        barkodSorgula(code);
        
        // Kamerayı durdur
        setTimeout(() => {
            stopSatisCamera();
        }, 1000); // 1 saniye sonra durdur (kullanıcı sonucu görsün)
    }

    function stopSatisCamera() {
        try {
            if (codeReader) {
                codeReader.reset();
                codeReader = null;
            }
            
            satisScanning = false;
            $('#satisKameraArea').addClass('d-none');
            $('#satisKameraBtn').prop('disabled', false)
                .html('<i class="fas fa-camera"></i> Kamera')
                .removeClass('btn-warning').addClass('btn-success');
            $('#satisScanResult').addClass('d-none');
            
            console.log('Kamera durduruldu');
            
        } catch (err) {
            console.error('Kamera durdurma hatası:', err);
        }
    }
    
    async function switchCamera() {
        if (!satisScanning || cameraDevices.length <= 1) return;
        
        try {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            // Mevcut kamerayı durdur
            if (codeReader) {
                codeReader.reset();
            }
            
            // Bir sonraki kamerayı seç
            const currentIndex = cameraDevices.findIndex(device => device.deviceId === selectedDeviceId);
            const nextIndex = (currentIndex + 1) % cameraDevices.length;
            selectedDeviceId = cameraDevices[nextIndex].deviceId;
            
            console.log('Kamera değiştiriliyor:', selectedDeviceId);
            console.log('iOS:', isIOS, 'Android:', isAndroid);
            
            // iOS ve Android için optimize edilmiş kamera başlatma
            try {
                if (isIOS) {
                    // iOS için özel başlatma
                    const constraints = {
                        video: {
                            deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 },
                            frameRate: { ideal: 30, max: 30 }
                        }
                    };
                    
                    // iOS için önce stream test et
                    const testStream = await navigator.mediaDevices.getUserMedia(constraints);
                    testStream.getTracks().forEach(track => track.stop());
                    
                    // Sonra ZXing ile başlat
                    await codeReader.decodeFromVideoDevice(selectedDeviceId, 'satisPreview', (result, err) => {
                        if (result) {
                            console.log('Barkod okundu:', result.text);
                            onBarcodeDetected(result.text);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.log('Okuma hatası:', err);
                        }
                    });
                    
                } else if (isAndroid) {
                    // Android için standart başlatma
                    await codeReader.decodeFromVideoDevice(selectedDeviceId, 'satisPreview', (result, err) => {
                        if (result) {
                            console.log('Barkod okundu:', result.text);
                            onBarcodeDetected(result.text);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.log('Okuma hatası:', err);
                        }
                    });
                } else {
                    // Masaüstü için standart başlatma
                    await codeReader.decodeFromVideoDevice(selectedDeviceId, 'satisPreview', (result, err) => {
                        if (result) {
                            console.log('Barkod okundu:', result.text);
                            onBarcodeDetected(result.text);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            console.log('Okuma hatası:', err);
                        }
                    });
                }
                
            } catch (switchErr) {
                console.log('Kamera değiştirme hatası, fallback yöntemi:', switchErr);
                
                // Fallback: deviceId olmadan başlat
                await codeReader.decodeFromVideoDevice(undefined, 'satisPreview', (result, err) => {
                    if (result) {
                        console.log('Barkod okundu:', result.text);
                        onBarcodeDetected(result.text);
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.log('Okuma hatası:', err);
                    }
                });
            }
            
            const cameraName = cameraDevices[nextIndex].label || `Kamera ${nextIndex + 1}`;
            
            // iOS için özel mesaj
            if (isIOS) {
                showAlert('info', `📱 iOS Kamera değiştirildi: ${cameraName}`);
            } else {
                showAlert('info', `Kamera değiştirildi: ${cameraName}`);
            }
            
        } catch (err) {
            console.error('Kamera değiştirme hatası:', err);
            
            if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                showAlert('warning', '📱 iOS: Kamera değiştirilemedi. Safari ayarlarını kontrol edin.');
            } else {
                showAlert('warning', 'Kamera değiştirilemedi. Tekrar deneyin.');
            }
        }
    }

    // Sayfa kapatılırken kamerayı durdur
    $(window).on('beforeunload', function() {
        stopSatisCamera();
    });
});
</script>
{% endblock %}

