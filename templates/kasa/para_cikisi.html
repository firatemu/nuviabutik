{% extends 'base.html' %}
{% load humanize %}

{% block title %}Para Çıkışı{% endblock %}

{% block extra_css %}
<style>
    .cikis-form {
        background: linear-gradient(135deg, #e8f4fd 0%, #c3d9f1 100%);
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 20px 40px rgba(195, 217, 241, 0.3), 0 8px 20px rgba(0,0,0,0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }
    
    .cikis-form::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        pointer-events: none;
    }
    
    .cikis-form h2 {
        color: #2c5282;
        text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        margin-bottom: 1.5rem;
        font-weight: 600;
    }
    
    .form-label {
        color: #2c5282;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
    }
    
    .form-select, .form-control {
        background-color: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        padding: 0.75rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .form-select:focus, .form-control:focus {
        border-color: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        background-color: rgba(255, 255, 255, 1);
        outline: none;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #7fb3d3 0%, #5a9bd4 100%);
        border: none;
        border-radius: 12px;
        padding: 0.8rem 2rem;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 8px 25px rgba(127, 179, 211, 0.4);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .btn-primary:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 12px 35px rgba(127, 179, 211, 0.6);
        background: linear-gradient(135deg, #5a9bd4 0%, #7fb3d3 100%);
    }
    
    .btn-primary:disabled {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        box-shadow: none;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .alert {
        border-radius: 15px;
        padding: 1rem 1.5rem;
        border: none;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .alert-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .alert-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        color: white;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        color: white;
    }
    
    #kasaBakiye {
        background: rgba(90, 155, 212, 0.15);
        border: 2px solid rgba(90, 155, 212, 0.3);
        border-radius: 15px;
        padding: 1rem;
        color: #2c5282;
        font-weight: 600;
        text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
    }
    
    #kasaBakiye.yetersiz-bakiye {
        background: rgba(220, 53, 69, 0.2);
        border-color: rgba(220, 53, 69, 0.5);
        animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    #tutarUyari {
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border-radius: 10px;
        padding: 0.75rem;
        margin-top: 0.5rem;
        animation: slideDown 0.3s ease-in-out;
    }
    
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #islemOzeti {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
    }
    
    .card-header {
        background: linear-gradient(135deg, #a8c8ec 0%, #7fb3d3 100%);
        color: white;
        border-radius: 20px 20px 0 0 !important;
        padding: 1.5rem;
        font-weight: 600;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
    }
    
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }
    
    .page-container {
        padding: 1rem;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .animate-fade-in {
        animation: fadeIn 0.8s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .form-floating label {
        color: rgba(0,0,0,0.6);
        font-weight: 500;
    }
    
    .input-group-text {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: #f093fb;
        font-weight: 600;
    }
    
    .kasa-bakiye {
        font-size: 1.2rem;
        font-weight: 600;
        color: white;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container animate-fade-in">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
            <div class="card">
                <div class="card-header text-center">
                    <h2 class="mb-0">
                        <i class="fas fa-minus-circle me-2"></i>
                        Para Çıkışı İşlemi
                    </h2>
                </div>
                <div class="card-body p-0">
                    <div class="cikis-form">
                        <form method="post" id="cikisForm">
                            {% csrf_token %}
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label"><i class="fas fa-wallet me-2"></i>Kasa Seçimi</label>
                                    <select name="kasa" id="kasa" class="form-select" required>
                                        <option value="">Kasa Seçin</option>
                                        {% for kasa in kasalar %}
                                        <option value="{{ kasa.id }}" data-bakiye="{{ kasa.guncel_bakiye }}">
                                            {{ kasa.ad }} - {{ kasa.guncel_bakiye|floatformat:2 }}₺
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="col-md-6">
                                    <label class="form-label"><i class="fas fa-coins me-2"></i>Çıkış Tutarı</label>
                                    <div class="input-group">
                                        <input type="number" name="tutar" id="tutar" class="form-control" 
                                               step="0.01" min="0.01" placeholder="0.00" required>
                                        <span class="input-group-text">₺</span>
                                    </div>
                                    <div id="tutarUyari" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Yetersiz bakiye! Lütfen daha düşük bir tutar girin.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label"><i class="fas fa-tags me-2"></i>Çıkış Sebebi</label>
                                    <select name="sebep" class="form-select" required>
                                        <option value="">Sebep Seçin</option>
                                        <option value="kisisel">Kişisel Çekim</option>
                                        <option value="harcama">Harcama</option>
                                        <option value="odeme">Ödeme</option>
                                        <option value="banka">Bankaya Yatırma</option>
                                        <option value="diger">Diğer</option>
                                    </select>
                                </div>
                                
                                <div class="col-md-6">
                                    <div id="kasaBakiye" style="display: none;">
                                        <label class="form-label"><i class="fas fa-chart-line me-2"></i>Mevcut Bakiye</label>
                                        <div class="kasa-bakiye" id="bakiyeTutar">0.00₺</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label class="form-label"><i class="fas fa-comment me-2"></i>Açıklama</label>
                                <textarea name="aciklama" class="form-control" rows="3" 
                                          placeholder="İşlemle ilgili detayları yazın..." required></textarea>
                            </div>
                            
                            <!-- İşlem Özeti -->
                            <div id="islemOzeti" style="display: none;" class="mt-4">
                                <h5 class="text-primary mb-3">
                                    <i class="fas fa-clipboard-check me-2"></i>İşlem Özeti
                                </h5>
                                <div id="ozetMetin"></div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button type="submit" id="cikisBtn" class="btn btn-primary btn-lg" disabled>
                                    <i class="fas fa-minus me-2"></i>Para Çıkışı Yap
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Geri Dön Butonu -->
            <div class="text-center mt-4">
                <a href="{% url 'kasa:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Kasa Yönetimine Dön
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Form işlevselliğini başlat
document.addEventListener('DOMContentLoaded', function() {
    // Kasa seçim değişikliklerini dinle
    $('#kasa').on('change', function() {
        updateBakiyeGoster();
        kontrolEt();
    });
        
        // Tutar değişikliklerini dinle
        $('#tutar').on('input', function() {
            kontrolEt();
        });
        
        // Form değişikliklerini dinle
        $('#cikisForm select, #cikisForm textarea').on('change input', function() {
            kontrolEt();
        });
        
        function updateBakiyeGoster() {
            const kasa = $('#kasa');
            
            if (kasa.val()) {
                const bakiye = parseFloat(kasa.find(':selected').data('bakiye')) || 0;
                $('#bakiyeTutar').text(bakiye.toFixed(2) + '₺');
                $('#kasaBakiye').fadeIn();
            } else {
                $('#kasaBakiye').fadeOut();
            }
        }
        
        function kontrolEt() {
            const kasa = $('#kasa').val();
            const tutar = parseFloat($('#tutar').val()) || 0;
            const sebep = $('select[name="sebep"]').val();
            const aciklama = $('textarea[name="aciklama"]').val().trim();
            const mevcutBakiye = parseFloat($('#kasa').find(':selected').data('bakiye')) || 0;
            
            let isValid = true;
            
            // Yetersiz bakiye kontrolü
            if (tutar > mevcutBakiye && tutar > 0) {
                isValid = false;
                $('#tutarUyari').fadeIn();
                $('#kasaBakiye').addClass('yetersiz-bakiye');
            } else {
                $('#tutarUyari').fadeOut();
                $('#kasaBakiye').removeClass('yetersiz-bakiye');
            }
            
            // Form kontrolü
            if (kasa && tutar > 0 && sebep && aciklama && isValid) {
                $('#cikisBtn').prop('disabled', false).removeClass('btn-secondary').addClass('btn-primary');
                updateIslemOzeti();
            } else {
                $('#cikisBtn').prop('disabled', true).removeClass('btn-primary').addClass('btn-secondary');
                $('#islemOzeti').fadeOut();
            }
        }
        
        function updateIslemOzeti() {
            const kasaAd = $('#kasa').find(':selected').text();
            const tutar = parseFloat($('#tutar').val()) || 0;
            const sebep = $('select[name="sebep"] option:selected').text();
            const mevcutBakiye = parseFloat($('#kasa').find(':selected').data('bakiye')) || 0;
            const yeniBakiye = mevcutBakiye - tutar;
            
            const ozetHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <strong>Kasa:</strong> ${kasaAd.split(' - ')[0]}<br>
                        <strong>Miktar:</strong> <span class="text-danger">${tutar.toFixed(2)}₺</span><br>
                        <strong>Sebep:</strong> ${sebep}
                    </div>
                    <div class="col-md-6">
                        <strong>Mevcut Bakiye:</strong> ${mevcutBakiye.toFixed(2)}₺<br>
                        <strong>Yeni Bakiye:</strong> <span class="${yeniBakiye < 0 ? 'text-danger' : 'text-success'} fw-bold">${yeniBakiye.toFixed(2)}₺</span>
                        ${yeniBakiye < 0 ? '<br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Negatif bakiye!</small>' : ''}
                    </div>
                </div>
            `;
            
            $('#ozetMetin').html(ozetHtml);
            $('#islemOzeti').fadeIn();
        }
        
        // Form submit kontrolü
        $('#cikisForm').on('submit', function(e) {
            if ($('#cikisBtn').prop('disabled')) {
                e.preventDefault();
                alert('Lütfen tüm alanları doldurun ve bakiye kontrolü yapın!');
                return false;
            }
            
            // Submit öncesi buton durumunu değiştir
            $('#cikisBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>İşleniyor...');
        });
        
    // Sayfa yüklendiğinde ilk kontrol
    kontrolEt();
});
</script>
{% endblock %}
