{% extends 'base.html' %}
{% load static %}

{% block title %}Stok Raporu{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Stok Raporu</h2>
        <div class="d-flex gap-2">
            <a href="{% url 'rapor:stok_excel' %}?durum={{ durum }}" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Excel İndir
            </a>
            <a href="{% url 'rapor:stok_pdf' %}?durum={{ durum }}" class="btn btn-danger">
                <i class="fas fa-file-pdf"></i> PDF İndir
            </a>
        </div>
    </div>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <i class="fas fa-filter me-2"></i>
                Filtreleme ve Arama
            </h6>
        </div>
        <div class="card-body">
            <form method="get" id="filterForm">
                <!-- Hidden fields for sorting -->
                <input type="hidden" name="sort" value="{{ sort_field }}">
                <input type="hidden" name="order" value="{{ sort_order }}">
                
                <div class="row g-3 mb-3">
                    <!-- Arama -->
                    <div class="col-md-4">
                        <label for="arama" class="form-label">Arama</label>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="arama" 
                                name="arama" 
                                value="{{ arama }}" 
                                placeholder="Ürün adı, barkod, renk, beden..."
                            >
                        </div>
                    </div>
                    
                    <!-- Kategori -->
                    <div class="col-md-2">
                        <label for="kategori" class="form-label">Kategori</label>
                        <select class="form-select" id="kategori" name="kategori">
                            <option value="">Tüm Kategoriler</option>
                            {% for kategori in kategoriler %}
                            <option value="{{ kategori.id }}" {% if kategori_id == kategori.id|stringformat:"s" %}selected{% endif %}>
                                {{ kategori.ad }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Marka -->
                    <div class="col-md-2">
                        <label for="marka" class="form-label">Marka</label>
                        <select class="form-select" id="marka" name="marka">
                            <option value="">Tüm Markalar</option>
                            {% for marka in markalar %}
                            <option value="{{ marka.id }}" {% if marka_id == marka.id|stringformat:"s" %}selected{% endif %}>
                                {{ marka.ad }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Stok Durumu -->
                    <div class="col-md-2">
                        <label for="durum" class="form-label">Stok Durumu</label>
                        <select class="form-select" id="durum" name="durum">
                            <option value="">Tümü</option>
                            <option value="normal" {% if durum == 'normal' %}selected{% endif %}>Normal (5+)</option>
                            <option value="kritik" {% if durum == 'kritik' %}selected{% endif %}>Kritik (1-5)</option>
                            <option value="tukendi" {% if durum == 'tukendi' %}selected{% endif %}>Tükendi (0)</option>
                        </select>
                    </div>
                    
                    <!-- Butonlar -->
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Filtrele
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Hızlı Filtreler -->
                <div class="row">
                    <div class="col-12">
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="?{% if sort_field %}sort={{ sort_field }}&order={{ sort_order }}{% endif %}" class="btn btn-outline-primary {% if not durum and not arama and not kategori_id and not marka_id %}active{% endif %}">
                                <i class="fas fa-list"></i> Tümü
                            </a>
                            <a href="?durum=tukendi{% if sort_field %}&sort={{ sort_field }}&order={{ sort_order }}{% endif %}" class="btn btn-outline-danger {% if durum == 'tukendi' %}active{% endif %}">
                                <i class="fas fa-times-circle"></i> Tükenenler
                            </a>
                            <a href="?durum=kritik{% if sort_field %}&sort={{ sort_field }}&order={{ sort_order }}{% endif %}" class="btn btn-outline-warning {% if durum == 'kritik' %}active{% endif %}">
                                <i class="fas fa-exclamation-triangle"></i> Kritik
                            </a>
                            <a href="?durum=normal{% if sort_field %}&sort={{ sort_field }}&order={{ sort_order }}{% endif %}" class="btn btn-outline-success {% if durum == 'normal' %}active{% endif %}">
                                <i class="fas fa-check-circle"></i> Normal
                            </a>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-eraser"></i> Temizle
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Sonuç Özeti -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="fas fa-boxes text-primary fs-4 me-2"></i>
                        <div>
                            <h5 class="mb-0">{{ varyantlar|length }}</h5>
                            <small class="text-muted">Bulunan Sonuç</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="fas fa-warehouse text-success fs-4 me-2"></i>
                        <div>
                            <h5 class="mb-0">{{ varyantlar|length }}</h5>
                            <small class="text-muted">Toplam Varyant</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="fas fa-exclamation-triangle text-warning fs-4 me-2"></i>
                        <div>
                            <h5 class="mb-0" id="kritikCount">-</h5>
                            <small class="text-muted">Kritik Stok</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="d-flex align-items-center justify-content-center">
                        <i class="fas fa-times-circle text-danger fs-4 me-2"></i>
                        <div>
                            <h5 class="mb-0" id="tukenenCount">-</h5>
                            <small class="text-muted">Tükenenler</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stok Tablosu -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                {% if durum == 'tukendi' %}
                    Tükenen Ürünler
                {% elif durum == 'kritik' %}
                    Kritik Stok Seviyesindeki Ürünler
                {% else %}
                    Tüm Ürünler
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="urun__ad">
                                Ürün Adı
                                <i class="fas fa-sort sort-icon ms-1"></i>
                            </th>
                            <th class="sortable" data-sort="renk__ad">
                                Varyant
                                <i class="fas fa-sort sort-icon ms-1"></i>
                            </th>
                            <th class="sortable" data-sort="barkod">
                                Barkod
                                <i class="fas fa-sort sort-icon ms-1"></i>
                            </th>
                            <th class="sortable" data-sort="urun__kategori__ad">
                                Kategori
                                <i class="fas fa-sort sort-icon ms-1"></i>
                            </th>
                            <th class="sortable" data-sort="urun__marka__ad">
                                Marka
                                <i class="fas fa-sort sort-icon ms-1"></i>
                            </th>
                            <th class="sortable" data-sort="urun__alis_fiyati">
                                Alış Fiyatı
                                <i class="fas fa-sort sort-icon ms-1"></i>
                            </th>
                            <th class="sortable" data-sort="urun__satis_fiyati">
                                Satış Fiyatı
                                <i class="fas fa-sort sort-icon ms-1"></i>
                            </th>
                            <th>Kar Oranı</th>
                            <th class="sortable" data-sort="stok_miktari">
                                Mevcut Stok
                                <i class="fas fa-sort sort-icon ms-1"></i>
                            </th>
                            <th>Durum</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for varyant in varyantlar %}
                        <tr>
                            <td>{{ varyant.urun.ad }}</td>
                            <td>
                                <small class="text-muted">
                                    {% if varyant.renk %}{{ varyant.renk.ad }}{% endif %}
                                    {% if varyant.renk and varyant.beden %} - {% endif %}
                                    {% if varyant.beden %}{{ varyant.beden.ad }}{% endif %}
                                    {% if not varyant.renk and not varyant.beden %}Standart{% endif %}
                                </small>
                            </td>
                            <td><code>{{ varyant.barkod }}</code></td>
                            <td>{{ varyant.urun.kategori.ad }}</td>
                            <td>{{ varyant.urun.marka.ad|default:"-" }}</td>
                            <td>
                                <span class="text-primary fw-bold">{{ varyant.urun.alis_fiyati|floatformat:2 }} ₺</span>
                            </td>
                            <td>
                                <span class="text-success fw-bold">{{ varyant.urun.satis_fiyati|floatformat:2 }} ₺</span>
                            </td>
                            <td>
                                {% with kar_orani=varyant.urun.kar_orani %}
                                    <span class="badge {% if kar_orani >= 50 %}bg-success{% elif kar_orani >= 30 %}bg-warning{% else %}bg-danger{% endif %}">
                                        %{{ kar_orani|floatformat:1 }}
                                    </span>
                                {% endwith %}
                            </td>
                            <td>
                                <span class="fw-bold {% if varyant.stok_miktari == 0 %}text-danger{% elif varyant.stok_miktari <= 5 %}text-warning{% else %}text-success{% endif %}">
                                    {{ varyant.stok_miktari }}
                                </span>
                            </td>
                            <td>
                                {% if varyant.stok_miktari == 0 %}
                                    <span class="badge bg-danger">Tükendi</span>
                                {% elif varyant.stok_miktari <= 5 %}
                                    <span class="badge bg-warning">Kritik</span>
                                {% else %}
                                    <span class="badge bg-success">Normal</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'rapor:stok_hareketleri' varyant.id %}" class="btn btn-outline-info btn-sm" title="Stok Hareketlerini Görüntüle">
                                    <i class="fas fa-history"></i> Hareketler
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center">Ürün bulunamadı.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .badge-kar-marji {
        font-size: 0.8em;
    }
    .table-responsive {
        border-radius: 0.375rem;
    }
    .table thead th {
        border-top: none;
    }
    .stok-badge {
        min-width: 50px;
    }
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .input-group-text {
        background-color: #e9ecef;
        border-color: #dee2e6;
    }
    
    /* Sıralama stilleri */
    .sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        background-color: #495057 !important;
        color: #ffffff !important;
    }
    
    /* Hover efekti kaldırıldı - sadece cursor pointer kalacak */
    .sortable:hover {
        background-color: #495057 !important;
        color: #ffffff !important;
    }
    
    /* Tablo başlık stilleri */
    .table thead th {
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        vertical-align: middle;
        padding: 12px 8px;
        background-color: #495057 !important;
        color: #ffffff !important;
    }
    
    .sort-icon {
        opacity: 0.6;
        font-size: 0.8em;
        margin-left: 4px;
        display: inline-block;
        color: #ffffff;
    }
    
    .sortable:hover .sort-icon {
        opacity: 0.8;
        color: #ffffff;
    }
    
    .sort-asc .sort-icon,
    .sort-desc .sort-icon {
        opacity: 1;
        color: #ffffff;
    }
    
    .sort-asc .sort-icon {
        transform: rotate(0deg);
    }
    
    .sort-desc .sort-icon {
        transform: rotate(180deg);
    }
    
    .sort-asc .sort-icon::before {
        content: "\f0de"; /* fa-sort-up */
    }
    
    .sort-desc .sort-icon::before {
        content: "\f0dd"; /* fa-sort-down */
    }
</style>

<script>
    // Filtreleri temizle
    function clearFilters() {
        // Sıralama parametrelerini koru
        const sortField = document.querySelector('input[name="sort"]').value;
        const sortOrder = document.querySelector('input[name="order"]').value;
        
        // Form alanlarını temizle
        document.getElementById('arama').value = '';
        document.getElementById('kategori').value = '';
        document.getElementById('marka').value = '';
        document.getElementById('durum').value = '';
        
        // Yeni URL oluştur (sadece sıralama ile)
        let newUrl = window.location.pathname;
        if (sortField && sortField !== 'urun__ad') {
            newUrl += `?sort=${sortField}&order=${sortOrder}`;
        }
        
        window.location.href = newUrl;
    }

    // Enter tuşu ile arama
    document.getElementById('arama').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('filterForm').submit();
        }
    });

    // Sayfa yüklendiğinde filtreleri kontrol et ve sayıları hesapla
    document.addEventListener('DOMContentLoaded', function() {
        // URL parametrelerini kontrol et ve sonuç sayısını güncelle
        const urlParams = new URLSearchParams(window.location.search);
        const hasFilters = urlParams.get('arama') || urlParams.get('kategori') || 
                          urlParams.get('marka') || urlParams.get('durum');
        
        if (hasFilters) {
            // Filtrelenmiş sonuçları vurgula
            const filterCard = document.querySelector('.card-header h6');
            if (filterCard) {
                filterCard.innerHTML = '<i class="fas fa-filter me-2 text-primary"></i>Filtreleme ve Arama (Aktif)';
            }
        }
        
        // Stok sayılarını hesapla ve sıralama event'lerini ekle
        calculateStockCounts();
        initializeSorting();
    });

    // Sıralama fonksiyonları
    function initializeSorting() {
        const sortableHeaders = document.querySelectorAll('.sortable');
        
        sortableHeaders.forEach(header => {
            header.addEventListener('click', function() {
                const sortField = this.getAttribute('data-sort');
                const currentSort = new URLSearchParams(window.location.search).get('sort');
                const currentOrder = new URLSearchParams(window.location.search).get('order');
                
                let newOrder = 'asc';
                if (currentSort === sortField && currentOrder === 'asc') {
                    newOrder = 'desc';
                }
                
                // Yeni URL oluştur
                const params = new URLSearchParams(window.location.search);
                params.set('sort', sortField);
                params.set('order', newOrder);
                
                // Sayfayı yenile
                window.location.search = params.toString();
            });
        });
        
        // Mevcut sıralama durumunu göster
        const currentSort = new URLSearchParams(window.location.search).get('sort');
        const currentOrder = new URLSearchParams(window.location.search).get('order');
        
        if (currentSort) {
            const activeHeader = document.querySelector(`[data-sort="${currentSort}"]`);
            if (activeHeader) {
                activeHeader.classList.add(currentOrder === 'desc' ? 'sort-desc' : 'sort-asc');
                
                // Diğer headerlardan sıralama sınıflarını kaldır
                sortableHeaders.forEach(header => {
                    if (header !== activeHeader) {
                        header.classList.remove('sort-asc', 'sort-desc');
                    }
                });
            }
        }
    }

    // Stok sayılarını hesapla
    function calculateStockCounts() {
        const rows = document.querySelectorAll('tbody tr');
        let kritikCount = 0;
        let tukenenCount = 0;
        
        rows.forEach(row => {
            const stokBadge = row.querySelector('.stok-badge');
            if (stokBadge) {
                const stokMiktari = parseInt(stokBadge.textContent);
                if (stokMiktari === 0) {
                    tukenenCount++;
                } else if (stokMiktari <= 5) {
                    kritikCount++;
                }
            }
        });
        
        // Sayıları güncelle
        document.getElementById('kritikCount').textContent = kritikCount;
        document.getElementById('tukenenCount').textContent = tukenenCount;
    }

    // Canlı arama (300ms gecikme ile)
    let searchTimeout;
    document.getElementById('arama').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            // İsteğe bağlı: otomatik arama
            // document.getElementById('filterForm').submit();
        }, 300);
    });

    // Excel export fonksiyonu
    function exportToExcel() {
        // Mevcut filtreleri al
        const params = new URLSearchParams(window.location.search);
        params.append('export', 'excel');
        
        // Export URL'ini oluştur
        const exportUrl = window.location.pathname + '?' + params.toString();
        
        // Yeni pencerede aç
        window.open(exportUrl, '_blank');
    }

    // Yazdırma fonksiyonu
    function printReport() {
        window.print();
    }

    // Responsive tablo scroll
    document.addEventListener('DOMContentLoaded', function() {
        const tableContainer = document.querySelector('.table-responsive');
        if (tableContainer) {
            tableContainer.addEventListener('scroll', function() {
                if (this.scrollLeft > 0) {
                    this.classList.add('shadow-sm');
                } else {
                    this.classList.remove('shadow-sm');
                }
            });
        }
    });
</script>
{% endblock %}
